<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Windows XP</title>
<link href="https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap" rel="stylesheet">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Tahoma", sans-serif;
  overflow: hidden;
  height: 100vh;
  cursor: default;
  user-select: none;
}

/* CURSEUR CUSTOM */
body, body * {
  cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M0,0 L0,13 L4,9 L7,16 L9,15 L6,8 L11,8 Z" fill="white" stroke="black"/></svg>') 0 0, auto !important;
}

button, .window-control, .start-button, .start-item, .start-footer, .taskbar-item, 
.desktop-icon, .file-item, .explorer-tree-item, .menu-item, .toolbar-button,
.chat-send, .browser-nav-btn, .error-button, .notif-header span:last-child {
  cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M0,0 L0,13 L4,9 L7,16 L9,15 L6,8 L11,8 Z" fill="white" stroke="black"/></svg>') 0 0, auto !important;
}

/* BUREAU */
#desktop {
  height: calc(100vh - 40px);
  background: linear-gradient(to bottom, #245edb 0%, #3f8cf3 50%, #245edb 100%);
  position: relative;
  overflow: hidden;
}

#desktop::before {
  content: "";
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(to bottom, transparent 0px, transparent 2px, rgba(0,0,0,0.08) 2px, rgba(0,0,0,0.08) 4px);
  pointer-events: none;
  animation: vhsScan 0.15s infinite;
}

@keyframes vhsScan {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.9; }
}

/* YEUX QUI SUIVENT */
.eye {
  position: fixed;
  font-size: 40px;
  pointer-events: none;
  z-index: 9999;
  animation: eyeFade 0.5s ease-in;
  text-shadow: 0 0 10px rgba(255,0,0,0.5);
}

@keyframes eyeFade {
  from { opacity: 0; transform: scale(0); }
  to { opacity: 1; transform: scale(1); }
}

/* NOTIFICATIONS */
.notification {
  position: fixed;
  bottom: 40px;
  right: 10px;
  width: 300px;
  background: linear-gradient(to bottom, #f0f0f0 0%, #d8d8d8 100%);
  border: 2px solid #0831d9;
  box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
  z-index: 10000;
  animation: notifSlide 0.3s ease-out;
}

@keyframes notifSlide {
  from { transform: translateX(320px); }
  to { transform: translateX(0); }
}

.notif-header {
  background: linear-gradient(to bottom, #0997ff 0%, #0066ff 100%);
  padding: 5px 8px;
  color: white;
  font-size: 11px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notif-body {
  padding: 10px;
  font-size: 11px;
  display: flex;
  gap: 10px;
  align-items: center;
}

.notif-icon {
  font-size: 32px;
}

/* IC√îNES BUREAU */
.desktop-icons {
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  height: 100%;
  flex-wrap: wrap;
  align-content: flex-start;
}

.desktop-icon {
  width: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  padding: 5px;
  cursor: pointer;
  border: 1px solid transparent;
  transition: all 0.1s;
}

.desktop-icon:hover {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.5);
}

.desktop-icon.selected {
  background: rgba(51,153,255,0.3);
  border: 1px solid rgba(51,153,255,0.8);
}

.icon-image {
  font-size: 48px;
  filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.5));
}

.icon-label {
  font-size: 11px;
  color: #ffffff;
  text-align: center;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
  word-wrap: break-word;
  max-width: 70px;
}

/* BARRE DES T√ÇCHES */
#taskbar {
  height: 40px;
  background: linear-gradient(to bottom, #245edb 0%, #1f4ba8 100%);
  border-top: 1px solid #1941a5;
  display: flex;
  align-items: center;
  padding: 0 2px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
}

.start-button {
  height: 32px;
  background: linear-gradient(to bottom, #5ebd5e 0%, #3d8b3d 100%);
  border: 1px solid #1a5c1a;
  border-radius: 3px;
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 0 12px;
  cursor: pointer;
  color: white;
  font-weight: bold;
  font-size: 12px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.start-button:hover {
  background: linear-gradient(to bottom, #6ecd6e 0%, #4d9b4d 100%);
}

.start-button:active {
  background: linear-gradient(to bottom, #4d9b4d 0%, #6ecd6e 100%);
}

.start-icon {
  font-size: 16px;
}

.taskbar-apps {
  flex: 1;
  display: flex;
  gap: 2px;
  margin-left: 5px;
  height: 100%;
  align-items: center;
}

.taskbar-item {
  height: 30px;
  background: linear-gradient(to bottom, #3d8aed 0%, #2868c8 100%);
  border: 1px solid #1941a5;
  border-radius: 2px;
  padding: 0 10px;
  display: flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  font-size: 11px;
  color: white;
  max-width: 160px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.taskbar-item:hover {
  background: linear-gradient(to bottom, #4d9afd 0%, #3878d8 100%);
}

.taskbar-item.active {
  background: linear-gradient(to bottom, #2868c8 0%, #1941a5 100%);
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
}

.system-tray {
  height: 100%;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 0 8px;
  border-left: 1px solid #1941a5;
  margin-left: 5px;
}

.tray-icon {
  font-size: 14px;
  cursor: pointer;
}

.clock {
  font-size: 11px;
  color: white;
  min-width: 50px;
  text-align: center;
}

/* MENU D√âMARRER */
#startMenu {
  position: absolute;
  bottom: 30px;
  left: 0;
  width: 320px;
  background: linear-gradient(to right, #245edb 0px, #245edb 50px, #f0f0f0 50px);
  border: 2px solid #0831d9;
  border-radius: 5px 5px 0 0;
  box-shadow: 3px 3px 10px rgba(0,0,0,0.5);
  display: none;
  z-index: 10000;
}

#startMenu.show {
  display: block;
  animation: slideUp 0.2s ease-out;
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.start-user {
  height: 50px;
  background: linear-gradient(to bottom, #5a8dd6 0%, #3f72b5 100%);
  display: flex;
  align-items: center;
  padding: 0 60px 0 10px;
  border-bottom: 1px solid #1941a5;
}

.start-user-icon {
  font-size: 32px;
  margin-right: 10px;
}

.start-user-name {
  font-size: 14px;
  font-weight: bold;
  color: white;
}

.start-items {
  padding: 5px 0;
}

.start-item {
  height: 32px;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 60px 0 10px;
  cursor: pointer;
  font-size: 11px;
}

.start-item:hover {
  background: #d1e5ff;
}

.start-item-icon {
  font-size: 20px;
  width: 24px;
  text-align: center;
}

.start-separator {
  height: 1px;
  background: #c0c0c0;
  margin: 3px 10px 3px 60px;
}

.start-footer {
  height: 36px;
  background: #4b8fd9;
  display: flex;
  align-items: center;
  padding: 0 60px 0 10px;
  cursor: pointer;
  gap: 8px;
  border-top: 1px solid #2868c8;
}

.start-footer:hover {
  background: #5a9ee9;
}

.start-footer-icon {
  font-size: 20px;
  margin-left: 5px;
}

.start-footer-text {
  font-size: 11px;
  font-weight: bold;
  color: white;
}

/* FEN√äTRES */
.window {
  position: absolute;
  background: #ece9d8;
  border: 3px solid;
  border-color: #0831d9 #0831d9 #042a7c #042a7c;
  box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
  min-width: 400px;
  min-height: 300px;
  display: none;
  flex-direction: column;
  z-index: 100;
}

.window.active {
  display: flex;
}

.window-titlebar {
  height: 28px;
  background: linear-gradient(to bottom, #0997ff 0%, #0053ee 50%, #0050ee 51%, #06f 100%);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 4px 0 8px;
  cursor: move;
}

.window-title {
  font-size: 11px;
  font-weight: bold;
  color: white;
  display: flex;
  align-items: center;
  gap: 5px;
}

.window-title-icon {
  font-size: 14px;
}

.window-controls {
  display: flex;
  gap: 2px;
}

.window-control {
  width: 21px;
  height: 21px;
  background: linear-gradient(to bottom, #f0f0f0 0%, #d8d8d8 100%);
  border: 1px solid #003c74;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
}

.window-control:hover {
  background: linear-gradient(to bottom, #ffffff 0%, #e8e8e8 100%);
}

.window-control:active {
  background: linear-gradient(to bottom, #d0d0d0 0%, #f0f0f0 100%);
}

.window-control.close {
  background: linear-gradient(to bottom, #ff6b6b 0%, #d93f3f 100%);
  color: white;
}

.window-control.close:hover {
  background: linear-gradient(to bottom, #ff8b8b 0%, #e95f5f 100%);
}

.window-content {
  flex: 1;
  overflow: auto;
  background: white;
}

.window-statusbar {
  height: 22px;
  background: #f0f0f0;
  border-top: 1px solid #c0c0c0;
  display: flex;
  align-items: center;
  padding: 0 8px;
  font-size: 11px;
  color: #000;
}

/* EXPLORATEUR */
.explorer-layout {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.explorer-toolbar {
  display: flex;
  align-items: center;
  gap: 3px;
  padding: 3px;
  background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
  border-bottom: 2px outset #dfdfdf;
  box-shadow: inset 1px 1px 0 rgba(255,255,255,0.8);
}

.explorer-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 22px;
  font-size: 11px;
  border: 2px solid;
  border-color: #dfdfdf #808080 #808080 #dfdfdf;
  background: #c0c0c0;
  cursor: pointer;
  transition: none;
}

.explorer-btn:active {
  border-color: #808080 #dfdfdf #dfdfdf #808080;
  background: #a8a8a8;
}

.explorer-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.explorer-separator {
  width: 1px;
  height: 20px;
  background: #dfdfdf;
  border-right: 1px solid rgba(255,255,255,0.5);
  margin: 0 2px;
}

.explorer-address-bar {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 3px 5px;
  background: #f0f0f0;
  border-bottom: 2px inset #c0c0c0;
  font-size: 11px;
}

.address-bar {
  flex: 1;
  padding: 3px 5px;
  border: 2px inset #c0c0c0;
  background: white;
  font-size: 11px;
  font-family: 'Segoe UI', Arial, sans-serif;
}

.explorer-content {
  display: flex;
  flex: 1;
  overflow: hidden;
  background: #f0f0f0;
}

.explorer-sidebar {
  width: 200px;
  background: #f0f0f0;
  border-right: 2px outset #dfdfdf;
  padding: 5px;
  overflow-y: auto;
  box-shadow: inset 1px 1px 0 rgba(255,255,255,0.8);
}

.explorer-sidebar-section {
  margin-bottom: 10px;
}

.explorer-sidebar-title {
  font-size: 10px;
  font-weight: bold;
  color: #000080;
  padding: 3px 5px;
  margin-bottom: 3px;
  text-transform: uppercase;
}

.explorer-tree-item {
  padding: 3px 5px;
  cursor: pointer;
  font-size: 11px;
  display: flex;
  align-items: center;
  gap: 5px;
  margin: 1px 0;
  border: 1px solid transparent;
}

.explorer-tree-item:hover {
  background: #3399ff;
  color: white;
  border: 1px solid #0078d7;
}

.explorer-tree-item.active {
  background: #3399ff;
  color: white;
  border: 1px solid #0078d7;
}

.explorer-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: white;
  border: 2px inset #c0c0c0;
  margin: 5px;
  box-shadow: inset 1px 1px 0 rgba(255,255,255,0.8);
}

.explorer-files {
  flex: 1;
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 15px;
  align-content: start;
  overflow-y: auto;
  background: white;
}

.explorer-status {
  display: flex;
  align-items: center;
  padding: 2px 5px;
  background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
  border-top: 2px inset #c0c0c0;
  font-size: 10px;
  color: #000;
  gap: 10px;
}

.status-item {
  display: flex;
  align-items: center;
  padding: 2px 5px;
  background: #c0c0c0;
  border: 2px inset #dfdfdf;
}

.file-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  padding: 5px;
  cursor: pointer;
  border: 1px solid transparent;
}

.file-item:hover {
  background: #d1e5ff;
  border: 1px solid #99c8ff;
}

.file-item.selected {
  background: #3399ff;
  border: 1px solid #0078d7;
}

.file-item.selected .file-name {
  color: white;
}

.file-icon {
  font-size: 32px;
}

.file-name {
  font-size: 11px;
  text-align: center;
  word-wrap: break-word;
  max-width: 70px;
  color: #000;
}

/* VISIONNEUSE D'IMAGES */
.image-viewer {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #2b2b2b;
  padding: 20px;
}

.image-viewer img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

.image-corrupted {
  animation: imageGlitch 0.5s infinite;
}

@keyframes imageGlitch {
  0%, 100% { filter: none; }
  25% { filter: hue-rotate(90deg) saturate(3); }
  50% { filter: invert(1); }
  75% { filter: contrast(5) brightness(0.5); }
}

/* NOTEPAD */
.notepad-content {
  width: 100%;
  height: 100%;
  border: none;
  padding: 5px;
  font-family: "Courier New", monospace;
  font-size: 12px;
  resize: none;
  background: white;
  color: #000;
}

/* CHAT */
.chat-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: white;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chat-message {
  padding: 8px;
  border-radius: 5px;
  max-width: 80%;
  font-size: 12px;
  word-wrap: break-word;
}

.chat-message.user {
  align-self: flex-end;
  background: #d1e5ff;
  border: 1px solid #0078d7;
}

.chat-message.system {
  align-self: flex-start;
  background: #f0f0f0;
  border: 1px solid #c0c0c0;
  font-family: "Courier New", monospace;
}

.chat-input-area {
  padding: 10px;
  background: #f0f0f0;
  border-top: 1px solid #c0c0c0;
  display: flex;
  gap: 5px;
}

.chat-input {
  flex: 1;
  padding: 5px;
  border: 1px solid #7f9db9;
  font-size: 11px;
  font-family: "Tahoma", sans-serif;
}

.chat-send {
  padding: 5px 15px;
  background: linear-gradient(to bottom, #f0f0f0 0%, #d8d8d8 100%);
  border: 1px solid #003c74;
  cursor: pointer;
  font-size: 11px;
}

/* NAVIGATEUR */
.browser-container {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.browser-toolbar {
  background: #f0f0f0;
  padding: 5px;
  border-bottom: 1px solid #c0c0c0;
  display: flex;
  gap: 5px;
}

.browser-nav-btn {
  padding: 3px 8px;
  background: linear-gradient(to bottom, #f0f0f0 0%, #d8d8d8 100%);
  border: 1px solid #a0a0a0;
  cursor: pointer;
  font-size: 11px;
}

.browser-url {
  flex: 1;
  padding: 3px 5px;
  border: 1px solid #7f9db9;
  font-size: 11px;
}

.browser-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: white;
  font-size: 12px;
}

.search-result {
  margin-bottom: 20px;
  padding: 10px;
  border: 1px solid #e0e0e0;
  cursor: pointer;
}

.search-result:hover {
  background: #f5f5f5;
}

.search-result-title {
  color: #0066cc;
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 5px;
}

.search-result-url {
  color: #008000;
  font-size: 10px;
  margin-bottom: 5px;
}

.search-result-desc {
  color: #545454;
  font-size: 11px;
}

/* PONG */
.pong-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  height: 100%;
  background: radial-gradient(circle at top, #141425 0%, #050510 55%, #000 100%);
  padding: 16px;
  box-sizing: border-box;
}

.pong-canvas {
  border-radius: 14px;
  border: 1px solid rgba(255, 255, 255, 0.15);
  box-shadow:
    0 0 25px rgba(64, 224, 255, 0.35),
    0 0 60px rgba(64, 224, 255, 0.15);
  background: radial-gradient(circle at center, #101020 0%, #050510 60%, #000 100%);
}

.pong-score {
  color: #e8f9ff;
  font-size: 20px;
  margin: 4px 0 2px;
  font-family: "Courier New", monospace;
  letter-spacing: 0.08em;
  padding: 6px 14px;
  border-radius: 999px;
  background: linear-gradient(135deg, rgba(64, 224, 255, 0.18), rgba(128, 90, 213, 0.12));
  box-shadow: 0 0 18px rgba(64, 224, 255, 0.35);
}

.pong-hint {
  color: #a8b5ff;
  margin-top: 6px;
  font-size: 12px;
  font-family: "Courier New", monospace;
  opacity: 0.85;
  text-transform: uppercase;
  letter-spacing: 0.12em;
}

/* VILLAGE 3D */
.village-container {
  display: flex;
  flex-direction: column;
  width: 100%;
  height: 100%;
  background: #000;
  position: relative;
}

#villageCanvas {
  flex: 1;
  display: block;
  background: #000;
  width: 100%;
  height: 100%;
}

.village-dialog {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 600px;
  background: rgba(0, 0, 0, 0.95);
  border: 2px solid #00ff00;
  padding: 12px;
  font-family: "Courier New", monospace;
  font-size: 12px;
  color: #00ff00;
  text-shadow: 0 0 8px rgba(0, 255, 0, 0.6);
  display: none;
  z-index: 1000;
  animation: dialogPop 0.3s ease-out;
  max-height: 120px;
  overflow-y: auto;
}

.village-dialog.show {
  display: block;
}

@keyframes dialogPop {
  from { opacity: 0; transform: translateX(-50%) scaleY(0.8); }
  to { opacity: 1; transform: translateX(-50%) scaleY(1); }
}

.dialog-name {
  color: #ffff00;
  font-weight: bold;
  margin-bottom: 6px;
  text-transform: uppercase;
}

.dialog-text {
  line-height: 1.4;
}


/* SCREAMER */
.screamer {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 99999;
  display: none;
  align-items: center;
  justify-content: center;
  animation: screamerFlash 0.1s infinite;
}

@keyframes screamerFlash {
  0%, 100% { background: #000; }
  50% { background: #f00; }
}

.screamer img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* BSOD (Blue Screen of Death) */
.bsod {
  position: fixed;
  inset: 0;
  background: #0000aa;
  z-index: 99999;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: flex-start;
  padding: 40px;
  color: #ffffff;
  font-family: "Courier New", monospace;
  overflow: hidden;
}

.bsod.active {
  display: flex;
  animation: bsodGlitch 0.15s infinite;
}

@keyframes bsodGlitch {
  0%, 100% { background: #0000aa; filter: brightness(1); }
  50% { background: #0000cc; filter: brightness(1.1); }
}

.bsod-content {
  max-width: 800px;
  line-height: 1.6;
  font-size: 14px;
}

.bsod-title {
  font-weight: bold;
  margin-bottom: 20px;
  font-size: 16px;
  animation: bsodFlicker 0.8s infinite;
}

@keyframes bsodFlicker {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.bsod-text {
  margin-bottom: 10px;
  word-break: break-all;
}

.bsod-error {
  color: #ffff00;
  font-weight: bold;
  margin-top: 15px;
}

.bsod-restart {
  margin-top: 30px;
  animation: bsodBlink 1s infinite;
}

@keyframes bsodBlink {
  0%, 49%, 100% { opacity: 1; }
  50%, 99% { opacity: 0; }
}

/* WEBCAM */
.webcam-container {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  background: #000;
  position: relative;
}

.webcam-status {
  position: absolute;
  top: 10px;
  left: 10px;
  color: #f00;
  font-size: 12px;
  background: rgba(0,0,0,0.7);
  padding: 5px 10px;
  border-radius: 3px;
}

.webcam-indicator {
  width: 8px;
  height: 8px;
  background: #f00;
  border-radius: 50%;
  display: inline-block;
  margin-right: 5px;
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* MESSAGES D'ERREUR */
.error-dialog {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 380px;
  background: #ece9d8;
  border: 3px solid;
  border-color: #0831d9 #0831d9 #042a7c #042a7c;
  box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
  z-index: 10001;
  display: none;
}

.error-dialog.show {
  display: block;
  animation: errorShake 0.3s;
}

@keyframes errorShake {
  0%, 100% { transform: translate(-50%, -50%); }
  25% { transform: translate(-52%, -50%); }
  75% { transform: translate(-48%, -50%); }
}

.error-titlebar {
  height: 24px;
  background: linear-gradient(to bottom, #cc0000 0%, #990000 100%);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 4px 0 8px;
  color: white;
  font-size: 11px;
  font-weight: bold;
}

.error-body {
  padding: 15px;
  display: flex;
  gap: 15px;
  align-items: flex-start;
}

.error-icon-large {
  font-size: 32px;
}

.error-message {
  flex: 1;
  font-size: 11px;
}

.error-buttons {
  padding: 0 15px 15px;
  display: flex;
  justify-content: center;
}

.error-button {
  padding: 5px 20px;
  background: linear-gradient(to bottom, #f0f0f0 0%, #d8d8d8 100%);
  border: 1px solid #003c74;
  cursor: pointer;
  font-size: 11px;
  font-weight: bold;
}

.error-button:hover {
  background: linear-gradient(to bottom, #ffffff 0%, #e8e8e8 100%);
}

/* PANNEAU DE CONFIGURATION */
.control-panel {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #ece9d8;
  color: #000;
}

.panel-tabs {
  display: flex;
  border-bottom: 1px solid #999;
  background: #d0cec8;
  padding: 5px;
  gap: 2px;
}

.panel-tab {
  padding: 5px 15px;
  cursor: pointer;
  background: #bfbbb0;
  border: 1px solid;
  border-color: #dfdbcd #42413f #dfdbcd #d0cdc8;
  border-radius: 3px 3px 0 0;
  font-size: 11px;
  font-weight: bold;
  color: #000;
}

.panel-tab.active {
  background: #ece9d8;
  border-color: #dfdbcd #42413f #ece9d8 #dfdbcd;
}

.panel-tab:hover {
  background: #cfc8bc;
}

.panel-content {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  position: relative;
}

.panel-section {
  display: none;
}

.panel-section.active {
  display: block;
}

.panel-section h3 {
  margin-top: 0;
  margin-bottom: 15px;
  font-size: 13px;
  color: #000;
  border-bottom: 1px solid #999;
  padding-bottom: 5px;
}

.setting-item {
  margin-bottom: 15px;
  padding: 10px;
  background: #f0ece4;
  border: 1px solid #999;
  border-radius: 3px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 11px;
}

.setting-item label {
  font-weight: bold;
  min-width: 120px;
  color: #000;
}

.setting-item input[type="color"] {
  width: 50px;
  height: 25px;
  cursor: pointer;
  border: 1px solid #999;
}

.setting-item input[type="checkbox"] {
  width: 14px;
  height: 14px;
  cursor: pointer;
}

.setting-item input[type="range"] {
  flex: 1;
  cursor: pointer;
  max-width: 150px;
}

.setting-item select {
  padding: 3px;
  border: 1px solid #999;
  background: #fff;
  cursor: pointer;
  font-size: 11px;
}

.setting-item button {
  padding: 4px 12px;
  background: linear-gradient(to bottom, #f0f0f0 0%, #d8d8d8 100%);
  border: 1px solid #999;
  cursor: pointer;
  font-size: 11px;
  border-radius: 2px;
}

.setting-item button:hover {
  background: linear-gradient(to bottom, #ffffff 0%, #e8e8e8 100%);
}

.setting-item span {
  min-width: 40px;
  text-align: right;
  color: #666;
}

.security-status {
  margin-top: 10px;
  padding: 10px;
  background: #000;
  color: #00ff00;
  border: 1px solid #00ff00;
  border-radius: 3px;
  font-family: "Courier New", monospace;
  font-size: 10px;
  min-height: 30px;
}

/* D√âMINEUR */
.minesweeper-container {
  padding: 12px;
  background: #c0c0c0;
  display: flex;
  flex-direction: column;
  gap: 8px;
  height: 100%;
  overflow: hidden;
}

.minesweeper-info {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  font-weight: bold;
  color: #000;
}

.minesweeper-grid {
  display: inline-grid;
  grid-template-columns: repeat(8, 30px);
  gap: 1px;
  background: #999;
  padding: 5px;
}

.mine-cell {
  width: 30px;
  height: 30px;
  background: linear-gradient(to bottom, #dfdbcd 0%, #a0a0a0 100%);
  border: 2px solid;
  border-color: #dfdbcd #42413f #42413f #dfdbcd;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: bold;
  font-size: 12px;
  user-select: none;
  color: #000;
}

.mine-cell:active {
  border-color: #42413f #dfdbcd #dfdbcd #42413f;
}

.mine-cell.revealed {
  background: #c0c0c0;
  border: 1px solid #999;
  color: #555;
}

.mine-cell.revealed.empty {
  color: #c0c0c0;
}

.mine-cell.revealed.mine {
  background: #000;
  color: #ff0000;
}

.mine-cell.revealed.number-1 { color: #0000ff; }
.mine-cell.revealed.number-2 { color: #008000; }
.mine-cell.revealed.number-3 { color: #ff0000; }
.mine-cell.revealed.number-4 { color: #000080; }
.mine-cell.revealed.number-5 { color: #800000; }
.mine-cell.revealed.number-6 { color: #008080; }
.mine-cell.revealed.number-7 { color: #000000; }
.mine-cell.revealed.number-8 { color: #808080; }

/* SNAKE */
.snake-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  gap: 8px;
  background: #000;
  overflow: hidden;
  padding: 8px;
}

.snake-score {
  color: #00ff00;
  font-family: "Courier New", monospace;
  font-size: 14px;
  font-weight: bold;
}

.snake-canvas {
  border: 2px solid #00ff00;
  background: #000;
  display: block;
  image-rendering: pixelated;
}

.snake-hint {
  color: #00ff00;
  font-size: 11px;
  font-family: "Courier New", monospace;
}

/* TAMAGOTCHI */
.tamagotchi-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 12px;
  background: #c0c0c0;
  height: 100%;
  overflow-y: auto;
  overflow-x: hidden;
}

.tamagotchi-display {
  width: 120px;
  height: 120px;
  background: linear-gradient(to bottom, #1a1a2e 0%, #0f3460 100%);
  border: 3px solid;
  border-color: #dfdbcd #42413f #42413f #dfdbcd;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 60px;
  box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5), 0 2px 5px rgba(0,0,0,0.3);
  flex-shrink: 0;
}

.tamagotchi-stats {
  font-size: 10px;
  color: #000;
  text-align: center;
  background: #dfdbcd;
  padding: 8px;
  border: 1px solid #999;
  min-width: 140px;
  flex-shrink: 0;
}

.tamagotchi-stats span {
  color: #003c74;
  font-weight: bold;
}

.tamagotchi-buttons {
  display: flex;
  flex-direction: column;
  gap: 3px;
  width: 100%;
  flex-shrink: 0;
}

.tamagotchi-btn {
  padding: 5px 8px;
  background: linear-gradient(to bottom, #dfdbcd 0%, #bfbbb0 100%);
  border: 2px solid;
  border-color: #dfdbcd #42413f #42413f #dfdbcd;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  color: #000;
  transition: none;
}

.tamagotchi-btn:active {
  border-color: #42413f #dfdbcd #dfdbcd #42413f;
}

.tamagotchi-btn:hover {
  background: linear-gradient(to bottom, #ece9d8 0%, #cfc8bc 100%);
}

/* BLOC-NOTES */
.notepad-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #fff;
  color: #000;
}

.notepad-text {
  flex: 1;
  padding: 10px;
  font-family: "Courier New", monospace;
  font-size: 12px;
  border: none;
  outline: none;
  resize: none;
  background: #fff;
  color: #000;
}

/* CALCULATRICE */
.calculator-container {
  padding: 6px;
  background: #c0c0c0;
  display: flex;
  flex-direction: column;
  gap: 3px;
  height: 100%;
  overflow: hidden;
}

.calc-display {
  background: #e8e8e8;
  color: #000;
  border: 2px solid;
  border-color: #dfdfdf #808080 #808080 #dfdfdf;
  padding: 6px 4px;
  text-align: right;
  font-family: "Tahoma", sans-serif;
  font-size: 18px;
  font-weight: bold;
  min-height: 32px;
  box-shadow: inset 1px 1px 0 rgba(255,255,255,0.8), inset -1px -1px 0 rgba(0,0,0,0.3);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 6px;
}

.calc-buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1px;
  flex: 1;
  min-height: 0;
}

.calc-btn {
  padding: 4px 4px;
  background: linear-gradient(to bottom, #f0f0f0 0%, #d8d8d8 100%);
  border: 2px solid;
  border-color: #dfdfdf #808080 #808080 #dfdfdf;
  cursor: pointer;
  font-size: 11px;
  font-weight: bold;
  color: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 0;
  font-family: "Tahoma", sans-serif;
}

.calc-btn:hover {
  background: linear-gradient(to bottom, #ffffff 0%, #e8e8e8 100%);
}

.calc-btn:active {
  border-color: #808080 #dfdfdf #dfdfdf #808080;
  background: linear-gradient(to bottom, #c0c0c0 0%, #e8e8e8 100%);
}

.calc-btn.operator {
  background: linear-gradient(to bottom, #f0f0f0 0%, #d8d8d8 100%);
  color: #000;
}

.calc-btn.operator:active {
  border-color: #808080 #dfdfdf #dfdfdf #808080;
}

.calc-btn.equals {
  background: linear-gradient(to bottom, #f0f0f0 0%, #d8d8d8 100%);
  color: #000;
  grid-column: span 2;
  font-size: 12px;
}

.calc-btn.equals:active {
  border-color: #808080 #dfdfdf #dfdfdf #808080;
}

/* GESTIONNAIRE DE T√ÇCHES */
.taskmanager-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #ece9d8;
  color: #000;
  font-size: 11px;
}

.task-tabs {
  display: flex;
  border-bottom: 1px solid #999;
  background: #d0cec8;
}

.task-tab {
  padding: 5px 15px;
  cursor: pointer;
  background: #bfbbb0;
  border: 1px solid #999;
  border-bottom: none;
}

.task-tab.active {
  background: #ece9d8;
}

.task-list {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.task-item {
  padding: 8px;
  background: #fff;
  border: 1px solid #999;
  margin-bottom: 5px;
  cursor: pointer;
  color: #000;
}

.task-item:hover {
  background: #dfdbcd;
}

.task-item.critical {
  background: #ffcccc;
  border-left: 3px solid #ff0000;
}

.task-buttons {
  padding: 10px;
  display: flex;
  gap: 5px;
  border-top: 1px solid #999;
}

.task-btn {
  padding: 5px 15px;
  background: linear-gradient(to bottom, #f0f0f0 0%, #d8d8d8 100%);
  border: 1px solid #999;
  cursor: pointer;
  font-size: 11px;
}

.task-btn:hover {
  background: linear-gradient(to bottom, #ffffff 0%, #e8e8e8 100%);
}

/* LECTEUR M√âDIA */
.media-player {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  gap: 15px;
  background: #c0c0c0;
  color: #000;
  padding: 20px;
}

.media-screen {
  width: 280px;
  height: 140px;
  background: #e8e8e8;
  border: 2px solid;
  border-color: #dfdfdf #808080 #808080 #dfdfdf;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: "Tahoma", sans-serif;
  font-size: 20px;
  font-weight: bold;
  color: #000;
  box-shadow: inset 1px 1px 0 rgba(255,255,255,0.8), inset -1px -1px 0 rgba(0,0,0,0.3);
}

@keyframes mediaGlitch {
  0%, 100% { filter: none; }
  50% { filter: hue-rotate(180deg) brightness(1.1); }
}

@keyframes blink {
  0%, 49%, 100% { opacity: 1; }
  50%, 99% { opacity: 0.3; }
}

@keyframes flicker {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.media-buttons {
  display: flex;
  gap: 3px;
}

.media-btn {
  padding: 6px 12px;
  background: linear-gradient(to bottom, #f0f0f0 0%, #d8d8d8 100%);
  color: #000;
  border: 2px solid;
  border-color: #dfdfdf #808080 #808080 #dfdfdf;
  cursor: pointer;
  font-weight: bold;
  border-radius: 0;
  font-family: "Tahoma", sans-serif;
  font-size: 11px;
}

.media-btn:hover {
  background: linear-gradient(to bottom, #ffffff 0%, #e8e8e8 100%);
}

.media-btn:active {
  border-color: #808080 #dfdfdf #dfdfdf #808080;
  background: linear-gradient(to bottom, #c0c0c0 0%, #e8e8e8 100%);
}

/* JOURNAL */
.journal-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #2a2a2a;
  color: #888;
  overflow: hidden;
}

.journal-entries {
  flex: 1;
  overflow: hidden !important;
  padding: 10px;
  font-family: "Courier New", monospace;
  font-size: 11px;
  line-height: 1.6;
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 100%;
}

.journal-entry {
  margin-bottom: 0;
  padding: 6px 8px;
  background: #1a1a1a;
  border-left: 2px solid #555;
  min-height: 0;
  flex-shrink: 0;
}

.journal-date {
  color: #00ff00;
  font-weight: bold;
  margin-bottom: 2px;
  font-size: 10px;
}

.journal-text {
  color: #888;
  word-break: break-word;
  font-size: 10px;
}

.journal-text.corrupted {
  color: #ff0000;
  text-decoration: line-through;
}

/* ===== SPRITE ANIMATION ===== */

#spawnCreepyBtn{
  position: fixed;
  right: 12px;
  bottom: 52px;
  z-index: 1000001;
  padding: 6px 10px;
  font-family: Tahoma, sans-serif;
  font-size: 12px;
  background: #c0c0c0;
  border: 2px outset #dfdfdf;
  color: #000;
}
#spawnCreepyBtn:active{ border: 2px inset #dfdfdf; }

.creepy-frame{
  position: fixed;
  width: 256px;   /* taille d‚Äôaffichage (pas la taille PNG) */
  height: 384px;
  background: #fff;
  border: 2px solid #000;
  z-index: 1000000;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.35);
}

.creepy-frame img{
  width: 100%;
  height: 100%;
  display: block;
  object-fit: contain;       /* garde les proportions */
  object-position: center;
  image-rendering: pixelated; /* si √ßa fait trop ‚Äúcr√©nel√©‚Äù, remplace par auto */
}
/* RESPONSIVE */
@media (max-width: 768px) {
  .window {
    min-width: 90% !important;
    max-width: 90% !important;
  }
  .explorer-sidebar {
    display: none;
  }
}
</style>
</head>
<body>
<button id="spawnCreepyBtn" onclick="spawnCreepy()">Lancer animation</button>
<div id="desktop">
  <div class="desktop-icons" id="desktopIcons">
    <!-- TOP LEFT PRIORITY -->
    <div class="desktop-icon" data-type="trash" ondblclick="openTrash()">
      <div class="icon-image">üóëÔ∏è</div>
      <div class="icon-label">Corbeille</div>
    </div>
    <div class="desktop-icon" data-type="folder" ondblclick="openFolder('relations')">
      <div class="icon-image">üìÅ</div>
      <div class="icon-label">relations</div>
    </div>
    
    <!-- DOCUMENTS -->
    <div class="desktop-icon" data-type="folder" ondblclick="openFolder('Mes documents')">
      <div class="icon-image">üìÑ</div>
      <div class="icon-label">Mes documents</div>
    </div>
    <div class="desktop-icon" data-type="image" ondblclick="openImage('him.jpg')">
      <div class="icon-image">üñºÔ∏è</div>
      <div class="icon-label">him.jpg</div>
    </div>
    
    <!-- GAMES -->
    <div class="desktop-icon" data-type="game" ondblclick="openPong()">
      <div class="icon-image">üéÆ</div>
      <div class="icon-label">pong.exe</div>
    </div>
    <div class="desktop-icon" data-type="game" ondblclick="openMinesweeper()">
      <div class="icon-image">üí£</div>
      <div class="icon-label">d√©mineur.exe</div>
    </div>
    <div class="desktop-icon" data-type="game" ondblclick="openSnake()">
      <div class="icon-image">üêç</div>
      <div class="icon-label">snake.exe</div>
    </div>
    <div class="desktop-icon" data-type="game" ondblclick="openTamagotchi()">
      <div class="icon-image">üëæ</div>
      <div class="icon-label">compagnon.exe</div>
    </div>
    
    <!-- APPLICATIONS -->
    <div class="desktop-icon" data-type="app" ondblclick="openNotepad()">
      <div class="icon-image">üìù</div>
      <div class="icon-label">Bloc-notes</div>
    </div>
    <div class="desktop-icon" data-type="app" ondblclick="openCalculator()">
      <div class="icon-image">üßÆ</div>
      <div class="icon-label">Calculatrice</div>
    </div>
    <div class="desktop-icon" data-type="app" ondblclick="openBrowser()">
      <div class="icon-image">üåê</div>
      <div class="icon-label">Internet Explorer</div>
    </div>
    <div class="desktop-icon" data-type="app" ondblclick="openChat()">
      <div class="icon-image">üí¨</div>
      <div class="icon-label">Messagerie</div>
    </div>
    <div class="desktop-icon" data-type="app" ondblclick="openMediaPlayer()">
      <div class="icon-image">üéµ</div>
      <div class="icon-label">Lecteur m√©dia</div>
    </div>
    <div class="desktop-icon" data-type="app" ondblclick="openJournal()">
      <div class="icon-image">üìì</div>
      <div class="icon-label">Mon journal</div>
    </div>
  </div>
</div>

<div id="taskbar">
  <div class="start-button" onclick="toggleStartMenu()">
    <span class="start-icon">ü™ü</span>
    <span>D√©marrer</span>
  </div>
  <div class="taskbar-apps" id="taskbarApps"></div>
  <div class="system-tray">
    <span class="tray-icon">üîä</span>
    <span class="clock" id="clock">00:00</span>
  </div>
</div>

<div id="startMenu">
  <div class="start-user">
    <span class="start-user-icon">üëÅÔ∏è</span>
    <span class="start-user-name">Ey.</span>
  </div>
  <div class="start-items">
    <div class="start-item" onclick="openFolder('Mes documents')">
      <span class="start-item-icon">üìÑ</span>
      <span>Mes documents</span>
    </div>
    <div class="start-item" onclick="openMyComputer()">
      <span class="start-item-icon">üíª</span>
      <span>Poste de travail</span>
    </div>
    <div class="start-separator"></div>
    <div class="start-item" onclick="openBrowser()">
      <span class="start-item-icon">üåê</span>
      <span>Internet Explorer</span>
    </div>
    <div class="start-item" onclick="openChat()">
      <span class="start-item-icon">üí¨</span>
      <span>Messagerie</span>
    </div>
    <div class="start-separator"></div>
    <div class="start-item" onclick="openPong()">
      <span class="start-item-icon">üéÆ</span>
      <span>Pong</span>
    </div>
    <div class="start-item" onclick="openMinesweeper()">
      <span class="start-item-icon">üí£</span>
      <span>D√©mineur</span>
    </div>
    <div class="start-item" onclick="openSnake()">
      <span class="start-item-icon">üêç</span>
      <span>Snake</span>
    </div>
    <div class="start-item" onclick="openTamagotchi()">
      <span class="start-item-icon">üëæ</span>
      <span>Compagnon</span>
    </div>
    <div class="start-separator"></div>
    <div class="start-item" onclick="openNotepad()">
      <span class="start-item-icon">üìù</span>
      <span>Bloc-notes</span>
    </div>
    <div class="start-item" onclick="openCalculator()">
      <span class="start-item-icon">üßÆ</span>
      <span>Calculatrice</span>
    </div>
    <div class="start-item" onclick="openTaskManager()">
      <span class="start-item-icon">‚öôÔ∏è</span>
      <span>Gestionnaire de t√¢ches</span>
    </div>
    <div class="start-item" onclick="openMediaPlayer()">
      <span class="start-item-icon">üéµ</span>
      <span>Lecteur m√©dia</span>
    </div>
    <div class="start-item" onclick="openJournal()">
      <span class="start-item-icon">üìì</span>
      <span>Journal</span>
    </div>
    <div class="start-separator"></div>
    <div class="start-item" onclick="openControlPanel()">
      <span class="start-item-icon">‚öôÔ∏è</span>
      <span>Panneau de configuration</span>
    </div>
  </div>
  <div class="start-footer" onclick="shutdown()">
    <span class="start-footer-icon">üî¥</span>
    <span class="start-footer-text">Arr√™ter l'ordinateur</span>
  </div>
</div>

<div id="errorDialog" class="error-dialog">
  <div class="error-titlebar">
    <span id="errorTitle">Erreur</span>
    <span class="window-control close" onclick="closeError()">‚úï</span>
  </div>
  <div class="error-body">
    <span class="error-icon-large">‚ö†Ô∏è</span>
    <div class="error-message" id="errorMessage"></div>
  </div>
  <div class="error-buttons">
    <button class="error-button" onclick="closeError()">OK</button>
  </div>
</div>

<div class="bsod" id="bsod">
  <div class="bsod-content">
    <div class="bsod-title">A problem has been detected and windows has been shut down to prevent damage to your computer.</div>
    <div class="bsod-text"></div>
    <div class="bsod-text">DRIVER_IRQL_NOT_LESS_OR_EQUAL</div>
    <div class="bsod-text"></div>
    <div class="bsod-text">If this is the first time you've seen this Stop error screen, restart your computer. If this screen appears again, follow these steps:</div>
    <div class="bsod-text"></div>
    <div class="bsod-text">Check to make sure any new hardware or software is properly installed.</div>
    <div class="bsod-text">If problems continue, disable or remove newly installed hardware or software.</div>
    <div class="bsod-text"></div>
    <div class="bsod-error">ERREUR SYST√àME D√âTECT√âE : CLAIRETTE.SYS</div>
    <div class="bsod-error">FICHIER CORROMPU - SUPPRESSION IMPOSS√çVEL</div>
    <div class="bsod-error">M√©moire de masse d√©faillante</div>
    <div class="bsod-text"></div>
    <div class="bsod-restart">Appuyez sur Ctrl+Alt+Suppr pour red√©marrer votre ordinateur.</div>
  </div>
</div>

<div class="screamer" id="screamer">
  <div style="color: white; font-size: 100px; animation: screamerFlash 0.1s infinite;">üëÅÔ∏è</div>
</div>

<script>
// ==================== SYST√àME DE SONS ====================
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

function playClickSound() {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value = 800;
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.05);
}

function playRightClickSound() {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value = 600;
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.05);
}

function playErrorSound() {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.type = 'square';
  osc.frequency.value = 400;
  gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.2);
}

function playStartupSound() {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.setValueAtTime(200, audioCtx.currentTime);
  osc.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.5);
  gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.5);
}

function playScreamerSound() {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.type = 'sawtooth';
  osc.frequency.value = 100;
  gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.3);
}

// ==================== DONN√âES DES FICHIERS ====================
const fileSystem = {
  'relations': {
    type: 'folder',
    files: {
      'haesoo.txt': {
        type: 'text',
        originalName: 'haesoo.txt',
        content: `Haesoo

Je l'aime plut√¥t bien. Elle est impressionnante.

Il y a quelque chose dans sa mani√®re d'√™tre qui force le respect. Une pr√©sence qui ne se nie pas. Elle poss√®de une force tranquille, une assurance qui n'a pas besoin de mots.

Je pense qu'elle pourrait accomplir de grandes choses.

- Ey.`
      },
      'aphiro.txt': {
        type: 'text',
        originalName: 'aphiro.txt',
        content: `Aphiro

Je ne lui ai jamais parl√© directement.

Mais d'apr√®s ce que j'ai pu observer, il semble fort. Puissant m√™me. Le genre de personne dont on sent l'√©nergie avant m√™me qu'elle n'ouvre la bouche.

Il y a quelque chose d'intimidant chez lui. Pas dans le mauvais sens. Juste... de la puissance brute.

J'aimerais peut-√™tre en savoir plus un jour.

- Ey.`
      },
      'koden.txt': {
        type: 'text',
        originalName: 'koden.txt',
        content: `KÃ∑Ã¢ÃõoÃ∏ÃßÃædÃ¥Ã®ÃàÃÅeÃµÃõÃ≥nÃ∂Ã∞Ãö

TÃµÃ¢ÃÜUÃ∂ÃπÕùEÃ∑Ã≥ÃΩRÃ∏ÕöÃï TÃ¥Ã∞ÃìUÃ∏Ã¢ÃçEÃ∑ÃõÃúRÃ∂Ã≠Õù TÃ∏Ã≥ÃæUÃµÕöÃáEÃ∑Ã¢ÃîRÃ∂Ã∞Õ† TÃµÃúÃàÃÅUÃ∏Ã≥ÕÜEÃ∂Ã¢ÃõRÃ∑Ã≥Õù TÃ¥ÃúÃøUÃ∂Ã¢ÃéEÃµÃ≥ÃîRÃ∏Ã∞Õë

Ã∂Ã≠ÃèJÃµÃ≥ÕùeÃ¥Ã¢Ãõ Ã∑Ã∞ÃÄnÃ∏ÃúÃàÃÅeÃ∂Ã¢Õù ÃµÃ≥ÃîpÃ∏Ã∞ÃïeÃµÃúÕùuÃ∂Ã¢ÃçxÃ∑Ã≥Õê Ã∏Ã∞ÃìpÃµÃúÃàÃÅ√§Ã¥ÃßsÃ∑Ã≥ÃàÃÅ Ã∏Ã∞ÃïmÃµÃúÃî'Ã∂Ã¢ÃõeÃ∑Ã≥ÃΩmÃ∏Ã∞ÕùpÃµÃúÃàÃÅ√™Ã∂Ã¢cÃ∑Ã≥ÃàÃÅ·∏ßÃ¥Ã∞eÃµÃúÕùrÃ∂Ã¢Ãõ Ã∑Ã≥ÃîdÃ∏Ã∞Ãï√´ÃµÃúÃÅ Ã∂Ã¢ÃçpÃ∑Ã≥ÃàÃÅ·∏õÃ∏ÕùnÃµÃúÃîsÃ∂Ã¢ÃõƒóÃ∑Ã≥rÃ∏Ã∞ÃàÃÅ ÃµÃúÃï√†Ã∂Ãß Ã∑Ã≥ÃîlÃ∏Ã∞ÃïuÃµÃúÕùiÃ∂Ã¢Ãõ

TÃ¥UÃ∑EÃ∏RÃ∂ TÃµUÃ∏EÃ∑RÃ∂ TÃ¥UÃ∑EÃ∏RÃ∂ TÃµUÃ∑EÃ∏RÃ∂ TÃ¥UÃ∑EÃ∏RÃ∂ TÃµUÃ∑EÃ∏RÃ∂ TÃ¥UÃ∑EÃ∏RÃ∂

QÃ∂Ã∞Ãï≈±Ã∏Ã¢ƒóÃ∑Ã≥lÃ∏ÕöÃàÃÅqÃµÃúÃî≈≠Ã∂Ã¢·∏ôÃ∑ÃàÃÅ Ã∏Ã∞ÃìcÃµÃúÃàhÃ∂Ã¢ÃõoÃ∑Ã≥ÕùsÃ∏Ã∞ÃïeÃµÃúÕù Ã∂Ã¢ÃçnÃ∑Ã≥ÃàÃÅ·∏õÃ∏ÃàÃÅ ÃµÃúÃïvÃ∂Ã¢Ãõ»ÅÃ∑Ã≥ Ã∏Ã∞ÃìpÃµÃúÃàÃÅ»ßÃ∂Ã¢sÃ∑Ã≥ÃàÃÅ.Ã∏Ã∞Ãï ÃµÃúÃîJÃ∂Ã¢Ãõ√´Ã∑Ã≥ÃÅ Ã∏Ã∞ÃìdÃµÃúÃï»ØÃ∂Ã¢«êÃ∑Ã≥sÃ∏Ã∞ÃàÃÅ ÃµÃúÃîlÃ∂Ã¢ÃõƒõÃ∑Ã≥ Ã∏Ã∞ÃàÃÅfÃµÃúÃï»ÉÃ∂Ãß«êÃ∑Ã≥rÃ∏Ã∞ÃïƒóÃµÃú Ã∂Ã¢ÃõtÃ∑Ã≥Ãî·∏ÅÃ∏Ãï«êÃµÃúrÃ∂Ã¢ÃõƒóÃ∑Ã≥

TÃµUÃ∏EÃ∑RÃ∂ TÃ¥UÃ∑EÃ∏RÃ∂ TÃµUÃ∏EÃ∑RÃ∂ TÃ¥UÃ∑EÃ∏RÃ∂ TÃµUÃ∏EÃ∑RÃ∂ TÃ¥UÃ∑EÃ∏RÃ∂ TÃµUÃ∏EÃ∑RÃ∂ TÃ¥UÃ∑EÃ∏RÃ∂

CÃ∑Ã≥ÃàÃÅ'Ã∏Ã∞Ãï·∏ôÃ∑ÃàÃÅsÃ∏ÃúÃîtÃ∂Ã¢Ãõ Ã∑Ã≥ÃàÃÅlÃ∏Ã∞Ãï»ßÃµÃú Ã∂Ã¢ÃçsÃ∑Ã≥Ãï·∏õÃ∏Ãá≈±ÃµÃúlÃ∂Ã¢Ãõ√´Ã∑Ã≥ Ã∏Ã∞ÃìsÃµÃúÃï»ØÃ∂ÃßlÃ∑Ã≥Ãî≈ØÃ∏Ã¢tÃµÃúÃî«êÃ∂Ã¢oÃ∑Ã≥ÕùnÃ∏Ã∞Ãï

TÃ∂UÃ∑EÃ∏RÃ∂ TÃµUÃ∑EÃ∏RÃ∂ TÃ¥UÃ∑EÃ∏RÃ∂ TÃµUÃ∑EÃ∏RÃ∂ TÃ¥UÃ∑EÃ∏RÃ∂ TÃµUÃ∑EÃ∏RÃ∂ TÃ¥UÃ∑EÃ∏RÃ∂ TÃµUÃ∑EÃ∏RÃ∂ TÃ¥UÃ∑EÃ∏RÃ∂`
      },
      'ozzy.txt': {
        type: 'corrupted',
        originalName: 'ozzy.txt',
        content: null
      },
      'maki.txt': {
        type: 'text',
        originalName: 'maki.txt',
        content: `Maki

Il y a quelque chose de doux dans son existence. Comme une lueur dans l'obscurit√©.

Quand je pense √† elle, je ressens une forme de paix. C'est rare. Pr√©cieux m√™me.

Elle a cette capacit√© √† rendre les choses plus l√©g√®res, plus supportables. Sans effort, sans artifice. Juste par sa pr√©sence.

Je crois que je l'appr√©cie particuli√®rement. Plus que je ne le pensais possible.

Elle me fait me sentir... presque humain.

- Ey.`
      },
      'journal.txt': {
        type: 'locked',
        originalName: 'journal.txt',
        content: null
      }
    }
  },
  'Mes documents': {
    type: 'folder',
    files: {}
  },
  'Corbeille': {
    type: 'trash',
    files: {
      'Remords.txt': { type: 'corrupted', content: null },
      'Regrets.txt': { type: 'corrupted', content: null },
      'photos_supprimees.jpg': { type: 'image', content: null }
    }
  },
  'souvenirs': {
    type: 'hidden',
    files: {
      'avant.txt': {
        type: 'text',
        content: `Avant.

Avant, je pensais que je pouvais contr√¥ler √ßa.
Avant, je pensais que c'√©tait juste des pens√©es.
Avant, je croyais encore que j'√©tais quelqu'un de bien.

Maintenant je sais.

Je sais ce que je suis.
Je sais ce que j'ai fait.
Je sais ce que je vais faire.

Et je ne peux pas m'arr√™ter.

- Ey.`
      },
      'face.jpg': {
        type: 'image',
        content: null
      }
    }
  }
};

// ==================== √âTAT DE L'APPLICATION ====================
let openWindows = [];
let activeWindow = null;
let zIndexCounter = 100;
let selectedIcon = null;
let draggedWindow = null;
let dragOffsetX = 0;
let dragOffsetY = 0;
let corruptionLevel = 0;
let ghostFilesSpawned = [];
let imageCorrupted = false;

// ==================== SYST√àME DE PROGRESSION ====================
let progressionState = {
  completedTasks: [],
  secretFileCreated: false
};

// Charger l'√©tat de progression
function loadProgression() {
  const saved = localStorage.getItem('progressionState');
  if (saved) {
    progressionState = JSON.parse(saved);
  }
}

// Sauvegarder la progression
function saveProgression() {
  localStorage.setItem('progressionState', JSON.stringify(progressionState));
}

// V√©rifier et ajouter le fichier secret si toutes les t√¢ches sont compl√©t√©es
function checkAllTasksCompleted() {
  if (progressionState.completedTasks.length === 10 && !progressionState.secretFileCreated) {
    progressionState.secretFileCreated = true;
    saveProgression();
    
    // Ajouter le fichier au bureau
    fileSystem['souvenirs'].files['rendezvous.txt'] = {
      type: 'text',
      content: `Elle arrive bient√¥t, je l'attends avec impatience √† l'entrep√¥t.

Les pr√©paratifs sont presque termin√©s.
Tout doit √™tre parfait.

Elle ne peut pas savoir.
Elle ne doit pas savoir.

Mais bient√¥t... elle saura.

- Ey.`
    };
    
    // Cr√©er une notification sp√©ciale
    const specialNotif = document.createElement('div');
    specialNotif.className = 'notification';
    specialNotif.style.backgroundColor = '#8b0000';
    specialNotif.style.borderColor = '#ff0000';
    specialNotif.innerHTML = `
      <div class="notif-header" style="background: #ff0000;">
        <span style="font-weight: bold; font-size: 14px;">‚ö†Ô∏è SYST√àME ALERTE ‚ö†Ô∏è</span>
      </div>
      <div class="notif-body" style="color: #fff; background: #8b0000;">
        <span class="notif-icon">üìÇ</span>
        <div>
          <strong>NOUVEAU FICHIER D√âTECT√â</strong><br>
          Un fichier a √©t√© cr√©√© sur votre bureau.<br>
          Progression: 100% ‚úì
        </div>
      </div>
    `;
    document.body.appendChild(specialNotif);
    playErrorSound();
    
    setTimeout(() => {
      specialNotif.style.transition = 'transform 0.3s, opacity 0.3s';
      specialNotif.style.transform = 'translateX(320px)';
      specialNotif.style.opacity = '0';
      setTimeout(() => specialNotif.remove(), 300);
    }, 8000);
    
    // Attendre un peu puis ajouter l'ic√¥ne
    setTimeout(() => {
      createNewDesktopIcon('rendezvous.txt', 'üìù', 'rendezvous.txt', 'text');
    }, 500);
  }
}

// Cr√©er une nouvelle ic√¥ne sur le bureau
function createNewDesktopIcon(id, emoji, label, type) {
  const container = document.getElementById('desktopIcons');
  const icon = document.createElement('div');
  icon.className = 'desktop-icon';
  icon.setAttribute('data-type', type);
  icon.ondblclick = function() {
    if (type === 'text') {
      const content = `<textarea class="notepad-content" readonly>${fileSystem['souvenirs'].files[id].content}</textarea>`;
      createWindow(label, emoji, content, 500, 400);
    }
  };
  icon.innerHTML = `
    <div class="icon-image">${emoji}</div>
    <div class="icon-label">${label}</div>
  `;
  container.appendChild(icon);
}

// ==================== INITIALISATION ====================
function init() {
  loadProgression();
  updateClock();
  setInterval(updateClock, 1000);
  
  // Plus de sons aux clics (enlev√©s)
  
  // Gestion des ic√¥nes
  document.querySelectorAll('.desktop-icon').forEach(icon => {
    icon.addEventListener('click', (e) => {
      if (selectedIcon) selectedIcon.classList.remove('selected');
      selectedIcon = icon;
      icon.classList.add('selected');
      e.stopPropagation();
    });
  });

  // D√©s√©lectionner si clic sur le bureau
  document.getElementById('desktop').addEventListener('click', (e) => {
    if (e.target.id === 'desktop' || e.target.className === 'desktop-icons') {
      if (selectedIcon) selectedIcon.classList.remove('selected');
      selectedIcon = null;
    }
    document.getElementById('startMenu').classList.remove('show');
  });

  // Fermer le menu d√©marrer si clic ailleurs
  document.addEventListener('click', (e) => {
    const startMenu = document.getElementById('startMenu');
    const startButton = document.querySelector('.start-button');
    if (!startMenu.contains(e.target) && !startButton.contains(e.target)) {
      startMenu.classList.remove('show');
    }
  });

  // D√©marrer les effets horrifiques
  setTimeout(() => {
    startHorrorEffects();
  }, 10000); // Commence apr√®s 10 secondes

  playStartupSound();
}

// ==================== EFFETS HORRIFIQUES ====================
function startHorrorEffects() {
  // Yeux qui apparaissent - MOINS FR√âQUENT
  setInterval(() => {
    if (Math.random() > 0.85) { // 15% de chance au lieu de 30%
      spawnEye();
    }
  }, 20000); // Toutes les 20 secondes au lieu de 8

  // Fichiers fant√¥mes
  setInterval(() => {
    if (Math.random() > 0.7) {
      spawnGhostFile();
    }
  }, 25000);

  // Corruption des noms de fichiers
  setInterval(() => {
    corruptFileNames();
  }, 30000);

  // Notifications - ENTRE 1 ET 5 MINUTES
  const scheduleNextNotification = () => {
    const delay = (60 + Math.random() * 240) * 1000; // Entre 60s et 300s (1-5 min)
    setTimeout(() => {
      showNotification();
      scheduleNextNotification();
    }, delay);
  };
  
  // Premi√®re notification apr√®s 30-90 secondes
  setTimeout(() => {
    showNotification();
    scheduleNextNotification();
  }, (30 + Math.random() * 60) * 1000);
}

function spawnEye() {
  const eye = document.createElement('div');
  eye.className = 'eye';
  eye.textContent = 'üëÅÔ∏è';
  
  const positions = [
    { top: '10px', left: '10px' },
    { top: '10px', right: '10px' },
    { bottom: '40px', left: '10px' },
    { bottom: '40px', right: '10px' }
  ];
  
  const pos = positions[Math.floor(Math.random() * positions.length)];
  Object.assign(eye.style, pos);
  
  document.body.appendChild(eye);
  
  // Suivre le curseur
  let lastX = 0, lastY = 0;
  const followMouse = (e) => {
    const rect = eye.getBoundingClientRect();
    const eyeX = rect.left + rect.width / 2;
    const eyeY = rect.top + rect.height / 2;
    const angle = Math.atan2(e.clientY - eyeY, e.clientX - eyeX);
    eye.style.transform = `rotate(${angle}rad)`;
  };
  
  document.addEventListener('mousemove', followMouse);
  
  setTimeout(() => {
    eye.style.animation = 'eyeFade 0.5s ease-out reverse';
    setTimeout(() => {
      eye.remove();
      document.removeEventListener('mousemove', followMouse);
    }, 500);
  }, 5000 + Math.random() * 5000);
}

function spawnGhostFile() {
  const ghostNames = [
    { name: 'ne_regarde_pas.txt', icon: 'üìÑ' },
    { name: 'il_te_voit.jpg', icon: 'üñºÔ∏è' },
    { name: 'souviens_toi.txt', icon: 'üìÑ' },
    { name: 'pourquoi.exe', icon: '‚ö†Ô∏è' },
    { name: 'retour.dll', icon: '‚ö†Ô∏è' }
  ];
  
  const ghost = ghostNames[Math.floor(Math.random() * ghostNames.length)];
  const desktopIcons = document.getElementById('desktopIcons');
  
  const icon = document.createElement('div');
  icon.className = 'desktop-icon ghost-file';
  icon.innerHTML = `
    <div class="icon-image">${ghost.icon}</div>
    <div class="icon-label">${ghost.name}</div>
  `;
  
  icon.ondblclick = () => {
    playErrorSound();
    showError('Erreur', 'Ce fichier n\'existe pas... ou plus.');
  };
  
  desktopIcons.appendChild(icon);
  ghostFilesSpawned.push(icon);
  
  setTimeout(() => {
    icon.style.transition = 'opacity 1s';
    icon.style.opacity = '0';
    setTimeout(() => icon.remove(), 1000);
  }, 8000);
}

function corruptFileNames() {
  corruptionLevel++;
  const relations = fileSystem['relations'].files;
  
  const corruptChar = (str, level) => {
    if (level === 0) return str;
    const chars = str.split('');
    const numToCorrupt = Math.min(level, chars.length);
    const glitchChars = ['Ã∑', 'Ã∏', 'Ã∂', 'Ã¥', 'Ãµ', 'Ã¢', 'Ãß', 'Ã®', 'Ãõ', 'Ã≥', 'Ã∞', 'Ãú', 'Ã≠', 'Õö', 'Õù', 'Ãæ', 'ÃàÃÅ', 'Ãö', 'Ãï', 'Ãì', 'Ãç', 'ÃΩ', 'Ãà', 'Ãá', 'Ãî'];
    
    for (let i = 0; i < numToCorrupt; i++) {
      const idx = Math.floor(Math.random() * chars.length);
      chars[idx] += glitchChars[Math.floor(Math.random() * glitchChars.length)];
    }
    return chars.join('');
  };
  
  for (let fileName in relations) {
    const file = relations[fileName];
    if (file.originalName && corruptionLevel > 0) {
      const newName = corruptChar(file.originalName, Math.min(corruptionLevel, 3));
      // On change le nom dans le DOM si la fen√™tre est ouverte
      const fileElements = document.querySelectorAll('.file-name');
      fileElements.forEach(el => {
        if (el.textContent === fileName) {
          el.textContent = newName;
        }
      });
    }
  }
}

function showNotification(customMsg) {
  let msg;
  
  if (customMsg) {
    msg = {
      title: customMsg.title || 'Syst√®me',
      text: customMsg.message || '',
      icon: customMsg.type === 'success' ? '‚úì' : '‚ö†Ô∏è'
    };
  } else {
    const messages = [
      { title: 'Syst√®me', text: 'Ey. te regarde', icon: 'üëÅÔ∏è' },
      { title: 'Alerte', text: 'Quelqu\'un essaie d\'acc√©der √† tes souvenirs', icon: '‚ö†Ô∏è' },
      { title: 'Message', text: 'Nouveau message de [SUPPRIM√â]', icon: 'üí¨' },
      { title: 'Erreur', text: 'La m√©moire est corrompue', icon: '‚ùå' },
      { title: 'Syst√®me', text: 'Tu ne peux pas t\'√©chapper', icon: 'üîí' },
      { title: 'Alerte', text: 'Il sait ce que tu as fait', icon: 'üëÅÔ∏è' },
      { title: 'Message', text: 'Pourquoi tu continues ?', icon: '‚ùì' }
    ];
    msg = messages[Math.floor(Math.random() * messages.length)];
  }
  
  const notif = document.createElement('div');
  notif.className = 'notification';
  notif.innerHTML = `
    <div class="notif-header">
      <span>${msg.title}</span>
      <span onclick="this.parentElement.parentElement.remove()" style="cursor:pointer;">‚úï</span>
    </div>
    <div class="notif-body">
      <span class="notif-icon">${msg.icon}</span>
      <span>${msg.text}</span>
    </div>
  `;
  
  document.body.appendChild(notif);
  playErrorSound();
  
  setTimeout(() => {
    notif.style.transition = 'transform 0.3s, opacity 0.3s';
    notif.style.transform = 'translateX(320px)';
    notif.style.opacity = '0';
    setTimeout(() => notif.remove(), 300);
  }, 5000);
}

// ==================== HORLOGE ====================
function updateClock() {
  const now = new Date();
  let hours = now.getHours();
  let minutes = now.getMinutes();
  
  // Parfois l'horloge bug
  if (Math.random() > 0.95) {
    hours = 3;
    minutes = 33;
  }
  
  const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
  document.getElementById('clock').textContent = timeStr;
}

// ==================== NOTIFICATIONS SYST√àME ====================
function showSystemNotification(title, message, type = 'info') {
  const notif = document.createElement('div');
  notif.className = 'system-notification';
  notif.style.cssText = `
    position: fixed;
    bottom: 40px;
    right: 10px;
    width: 300px;
    background: ${type === 'warning' ? '#ffcc00' : type === 'error' ? '#ff3333' : '#ece9d8'};
    border: 2px solid;
    border-color: ${type === 'warning' ? '#cc9900' : type === 'error' ? '#990000' : '#999'};
    padding: 15px;
    border-radius: 3px;
    z-index: 10000;
    font-family: Tahoma, sans-serif;
    font-size: 11px;
    color: #000;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    animation: slideInRight 0.3s ease-out;
  `;
  notif.innerHTML = `
    <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
    <div>${message}</div>
  `;
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.animation = 'slideOutRight 0.3s ease-out';
    setTimeout(() => notif.remove(), 300);
  }, 4000);
}

// Lancer des notifications al√©atoires
setInterval(() => {
  if (Math.random() > 0.85) {
    const notifications = [
      { title: '‚ö†Ô∏è Attention', message: 'Fichiers syst√®me corrompus d√©tect√©s.', type: 'warning' },
      { title: 'üîí S√©curit√©', message: 'Tentative d\'acc√®s √† des fichiers priv√©s.', type: 'error' },
      { title: 'üì• Mise √† jour', message: 'Nouvelle mise √† jour disponible: v666.6.6', type: 'info' },
      { title: 'üîç Scan', message: '√âl√©ment suspect trouv√© dans la m√©moire.', type: 'warning' },
      { title: '‚öôÔ∏è Syst√®me', message: 'Processus inconnu ex√©cut√©.', type: 'error' }
    ];
    const rand = notifications[Math.floor(Math.random() * notifications.length)];
    showSystemNotification(rand.title, rand.message, rand.type);
  }
}, 30000);

// ==================== TH√àMES ====================
const themes = {
  'Classique': {
    primary: '#245edb',
    secondary: '#3f8cf3',
    text: '#000'
  },
  'Noir sombre': {
    primary: '#1a1a1a',
    secondary: '#333',
    text: '#00ff00'
  },
  'Matrix': {
    primary: '#001100',
    secondary: '#003300',
    text: '#00ff00'
  },
  'Rose glitch': {
    primary: '#ff0080',
    secondary: '#ff00ff',
    text: '#fff'
  }
};

function applyTheme(themeName) {
  const theme = themes[themeName];
  if (!theme) return;

  const desktop = document.getElementById('desktop');
  desktop.style.background = `linear-gradient(to bottom, ${theme.primary} 0%, ${theme.secondary} 50%, ${theme.primary} 100%)`;
  
  // Appliquer aux fen√™tres aussi
  document.querySelectorAll('.window').forEach(win => {
    win.style.color = theme.text;
  });
}

// ==================== OEUFS DE P√ÇQUES ====================
let secretCode = '';
const secretSequences = {
  'UP UP DOWN DOWN LEFT RIGHT LEFT RIGHT B A': () => {
    showError('CHEAT CODE', 'Mode god activ√©! üëΩ');
    document.body.style.filter = 'invert(1) hue-rotate(180deg)';
  },
  'K O D E N': () => {
    showError('ERROR', 'Vous ne devriez pas √™tre ici...');
    document.body.style.opacity = '0.5';
    setTimeout(() => { document.body.style.opacity = '1'; }, 2000);
  },
  'S T A R T': () => {
    for (let i = 0; i < 10; i++) {
      setTimeout(() => {
        showSystemNotification('üí´ Wow', 'Tu as trouv√© quelque chose!', 'info');
      }, i * 500);
    }
  }
};

document.addEventListener('keydown', (e) => {
  const key = e.key.toUpperCase();
  secretCode += key + ' ';
  secretCode = secretCode.slice(-50); // Garder les 50 derniers caract√®res

  for (const sequence in secretSequences) {
    if (secretCode.includes(sequence)) {
      secretSequences[sequence]();
      secretCode = '';
      break;
    }
  }
});

// Injection de keyframes manquantes pour les animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideInRight {
    from {
      transform: translateX(350px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(350px);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);

// ==================== MENU D√âMARRER ====================
function toggleStartMenu() {
  const menu = document.getElementById('startMenu');
  menu.classList.toggle('show');
}

// ==================== GESTION DES FEN√äTRES ====================
function createWindow(title, icon, content, width = 600, height = 450) {
  const windowId = 'window-' + Date.now();
  const window = document.createElement('div');
  window.className = 'window active';
  window.id = windowId;
  window.style.width = width + 'px';
  window.style.height = height + 'px';
  window.style.left = (Math.random() * 200 + 100) + 'px';
  window.style.top = (Math.random() * 100 + 50) + 'px';
  window.style.zIndex = ++zIndexCounter;

  window.innerHTML = `
    <div class="window-titlebar" onmousedown="startDrag(event, '${windowId}')">
      <div class="window-title">
        <span class="window-title-icon">${icon}</span>
        <span>${title}</span>
      </div>
      <div class="window-controls">
        <div class="window-control" onclick="minimizeWindow('${windowId}')">_</div>
        <div class="window-control" onclick="maximizeWindow('${windowId}')">‚ñ°</div>
        <div class="window-control close" onclick="closeWindow('${windowId}')">‚úï</div>
      </div>
    </div>
    <div class="window-content">
      ${content}
    </div>
    <div class="window-statusbar">Pr√™t</div>
  `;

  document.body.appendChild(window);
  openWindows.push(windowId);
  activeWindow = windowId;
  updateTaskbar();

  window.addEventListener('mousedown', () => {
    activateWindow(windowId);
  });

  return windowId;
}

function activateWindow(windowId) {
  document.querySelectorAll('.window').forEach(w => w.style.zIndex = 100);
  const window = document.getElementById(windowId);
  if (window) {
    window.style.zIndex = ++zIndexCounter;
    activeWindow = windowId;
    updateTaskbar();
  }
}

function closeWindow(windowId) {
  const window = document.getElementById(windowId);
  if (window) {
    window.remove();
    openWindows = openWindows.filter(id => id !== windowId);
    if (activeWindow === windowId) {
      activeWindow = openWindows[openWindows.length - 1] || null;
    }
    updateTaskbar();
  }
}

function minimizeWindow(windowId) {
  const window = document.getElementById(windowId);
  if (window) {
    window.style.display = 'none';
    updateTaskbar();
  }
}

function maximizeWindow(windowId) {
  const window = document.getElementById(windowId);
  if (window) {
    if (window.style.width === '100%') {
      window.style.width = '600px';
      window.style.height = '450px';
      window.style.left = '100px';
      window.style.top = '50px';
    } else {
      window.style.width = '100%';
      window.style.height = 'calc(100vh - 30px)';
      window.style.left = '0';
      window.style.top = '0';
    }
  }
}

function restoreWindow(windowId) {
  const window = document.getElementById(windowId);
  if (window) {
    window.style.display = 'flex';
    activateWindow(windowId);
  }
}

// ==================== DRAG AND DROP ====================
function startDrag(e, windowId) {
  draggedWindow = document.getElementById(windowId);
  const rect = draggedWindow.getBoundingClientRect();
  dragOffsetX = e.clientX - rect.left;
  dragOffsetY = e.clientY - rect.top;
  
  document.addEventListener('mousemove', dragWindow);
  document.addEventListener('mouseup', stopDrag);
  activateWindow(windowId);
}

function dragWindow(e) {
  if (draggedWindow) {
    draggedWindow.style.left = (e.clientX - dragOffsetX) + 'px';
    draggedWindow.style.top = (e.clientY - dragOffsetY) + 'px';
  }
}

function stopDrag() {
  draggedWindow = null;
  document.removeEventListener('mousemove', dragWindow);
  document.removeEventListener('mouseup', stopDrag);
}

// ==================== BARRE DES T√ÇCHES ====================
function updateTaskbar() {
  const taskbarApps = document.getElementById('taskbarApps');
  taskbarApps.innerHTML = '';
  
  openWindows.forEach(windowId => {
    const window = document.getElementById(windowId);
    if (window) {
      const title = window.querySelector('.window-title span:last-child').textContent;
      const icon = window.querySelector('.window-title-icon').textContent;
      const isActive = window.style.display !== 'none';
      
      const taskbarItem = document.createElement('div');
      taskbarItem.className = 'taskbar-item' + (windowId === activeWindow && isActive ? ' active' : '');
      taskbarItem.innerHTML = `<span>${icon}</span><span>${title}</span>`;
      taskbarItem.onclick = () => {
        if (window.style.display === 'none') {
          restoreWindow(windowId);
        } else if (windowId === activeWindow) {
          minimizeWindow(windowId);
        } else {
          activateWindow(windowId);
        }
      };
      taskbarApps.appendChild(taskbarItem);
    }
  });
}

// ==================== EXPLORATEUR DE FICHIERS ====================
// Explorer navigation history
window.explorerHistory = [];
window.explorerHistoryIndex = -1;

function openFolder(folderName) {
  const content = createExplorerContent(folderName);
  createWindow(folderName, 'üìÅ', content, 800, 550);
  document.getElementById('startMenu').classList.remove('show');
  // Add to history
  window.explorerHistory.push(folderName);
  window.explorerHistoryIndex = window.explorerHistory.length - 1;
}

function createExplorerContent(folderName) {
  const folder = fileSystem[folderName];
  if (!folder) return '<div style="padding: 20px;">Dossier introuvable</div>';

  // Track opening souvenirs
  if (folderName === 'souvenirs') {
    window.visitedSouvenirs = true;
  }

  let filesHTML = '';
  let fileCount = 0;
  for (const [fileName, fileData] of Object.entries(folder.files)) {
    const icon = getFileIcon(fileData.type);
    filesHTML += `
      <div class="file-item" ondblclick="openFile('${folderName}', '${fileName}')">
        <div class="file-icon">${icon}</div>
        <div class="file-name">${fileName}</div>
      </div>
    `;
    fileCount++;
  }

  return `
    <div class="explorer-layout">
      <div class="explorer-toolbar">
        <button class="explorer-btn" title="Pr√©c√©dent" onclick="explorerNavigateBack()">‚óÑ</button>
        <button class="explorer-btn" title="Suivant" onclick="explorerNavigateForward()">‚ñ∫</button>
        <button class="explorer-btn" title="Vers le haut" onclick="explorerGoUp()">‚ñ≤</button>
        <div class="explorer-separator"></div>
        <button class="explorer-btn" title="Accueil" onclick="openFolder('Mes documents')">üè†</button>
      </div>
      <div class="explorer-address-bar">
        <span>Adresse:</span>
        <input type="text" class="address-bar" value="C:\\${folderName}" readonly>
      </div>
      <div class="explorer-content">
        <div class="explorer-sidebar">
          <div class="explorer-sidebar-section">
            <div class="explorer-sidebar-title">Raccourcis</div>
            <div class="explorer-tree-item" onclick="openFolder('Mes documents')">üìÑ Mes documents</div>
            <div class="explorer-tree-item" onclick="openMyComputer()">üíª Poste de travail</div>
            <div class="explorer-tree-item" onclick="openTrash()">üóëÔ∏è Corbeille</div>
          </div>
          <div class="explorer-sidebar-section">
            <div class="explorer-sidebar-title">Autres</div>
            <div class="explorer-tree-item" onclick="openFolder('relations')">üìÅ relations</div>
            <div class="explorer-tree-item" onclick="openFolder('souvenirs')" style="opacity: 0.3;">üìÇ ???</div>
          </div>
        </div>
        <div class="explorer-main">
          <div class="explorer-files">
            ${filesHTML}
          </div>
        </div>
      </div>
      <div class="explorer-status">
        <span>${fileCount} objet(s)</span>
      </div>
    </div>
  `;
}

function explorerNavigateBack() {
  if (window.explorerHistoryIndex > 0) {
    window.explorerHistoryIndex--;
    const folderName = window.explorerHistory[window.explorerHistoryIndex];
    // Recreate window with new content - implementation would need window reference
  }
}

function explorerNavigateForward() {
  if (window.explorerHistoryIndex < window.explorerHistory.length - 1) {
    window.explorerHistoryIndex++;
    const folderName = window.explorerHistory[window.explorerHistoryIndex];
    // Recreate window with new content - implementation would need window reference
  }
}

function explorerGoUp() {
  // Navigate to parent folder
  openFolder('Mes documents');
}

function getFileIcon(type) {
  switch(type) {
    case 'text': return 'üìÑ';
    case 'folder': return 'üìÅ';
    case 'corrupted': return '‚ö†Ô∏è';
    case 'image': return 'üñºÔ∏è';
    case 'locked': return 'üîí';
    default: return 'üìÑ';
  }
}

function openFile(folderName, fileName) {
  const fileData = fileSystem[folderName].files[fileName];
  
  // Track opening koden.txt
  if (fileName === 'koden.txt' && folderName === 'relations') {
    window.openedKodenFile = true;
  }
  
  if (fileData.type === 'corrupted') {
    playErrorSound();
    showError('Erreur d\'ouverture', `Le fichier "${fileName}" est corrompu et ne peut pas √™tre ouvert.`);
    return;
  }

  if (fileData.type === 'locked') {
    playErrorSound();
    showError('Fichier en cours d\'utilisation', `Le fichier "${fileName}" est actuellement utilis√© par un autre programme.\n\nFermez tous les programmes susceptibles d'utiliser ce fichier, puis r√©essayez.`);
    return;
  }

  if (fileData.type === 'text') {
    const content = `<textarea class="notepad-content" readonly>${fileData.content}</textarea>`;
    createWindow(fileName, 'üìÑ', content, 500, 400);
  }

  if (fileData.type === 'image') {
    openImage('face.jpg', true);
  }
}

// ==================== POSTE DE TRAVAIL ====================
function openMyComputer() {
  const content = `
    <div class="explorer-layout">
      <div class="explorer-toolbar">
        <button class="explorer-btn" title="Pr√©c√©dent" onclick="explorerNavigateBack()" disabled>‚óÑ</button>
        <button class="explorer-btn" title="Suivant" onclick="explorerNavigateForward()" disabled>‚ñ∫</button>
        <button class="explorer-btn" title="Vers le haut" onclick="explorerGoUp()" disabled>‚ñ≤</button>
        <div class="explorer-separator"></div>
        <button class="explorer-btn" title="Accueil" onclick="openFolder('Mes documents')">üè†</button>
      </div>
      <div class="explorer-address-bar">
        <span>Adresse:</span>
        <input type="text" class="address-bar" value="Poste de travail" readonly>
      </div>
      <div class="explorer-content">
        <div class="explorer-sidebar">
          <div class="explorer-sidebar-section">
            <div class="explorer-sidebar-title">Raccourcis</div>
            <div class="explorer-tree-item" onclick="openFolder('Mes documents')">üìÑ Mes documents</div>
            <div class="explorer-tree-item active">üíª Poste de travail</div>
            <div class="explorer-tree-item" onclick="openTrash()">üóëÔ∏è Corbeille</div>
          </div>
        </div>
        <div class="explorer-main">
          <div class="explorer-files">
            <div class="file-item" ondblclick="openFolder('Mes documents')">
              <div class="file-icon">üìÑ</div>
              <div class="file-name">Mes documents</div>
            </div>
            <div class="file-item" ondblclick="openFolder('relations')">
              <div class="file-icon">üìÅ</div>
              <div class="file-name">relations</div>
            </div>
            <div class="file-item">
              <div class="file-icon">üíæ</div>
              <div class="file-name">Disque local (C:)</div>
            </div>
          </div>
        </div>
      </div>
      <div class="explorer-status">
        <span>3 objet(s)</span>
      </div>
    </div>
  `;
  createWindow('Poste de travail', 'üíª', content, 800, 550);
  document.getElementById('startMenu').classList.remove('show');
}

// ==================== CORBEILLE ====================
function openTrash() {
  const content = `
    <div class="explorer-layout">
      <div class="explorer-toolbar">
        <button class="explorer-btn" title="Pr√©c√©dent" onclick="explorerNavigateBack()" disabled>‚óÑ</button>
        <button class="explorer-btn" title="Suivant" onclick="explorerNavigateForward()" disabled>‚ñ∫</button>
        <button class="explorer-btn" title="Vers le haut" onclick="explorerGoUp()" disabled>‚ñ≤</button>
        <div class="explorer-separator"></div>
        <button class="explorer-btn" title="Accueil" onclick="openFolder('Mes documents')">üè†</button>
      </div>
      <div class="explorer-address-bar">
        <span>Adresse:</span>
        <input type="text" class="address-bar" value="Corbeille" readonly>
      </div>
      <div class="explorer-content">
        <div class="explorer-sidebar">
          <div class="explorer-sidebar-section">
            <div class="explorer-sidebar-title">Raccourcis</div>
            <div class="explorer-tree-item" onclick="openFolder('Mes documents')">üìÑ Mes documents</div>
            <div class="explorer-tree-item" onclick="openMyComputer()">üíª Poste de travail</div>
            <div class="explorer-tree-item active">üóëÔ∏è Corbeille</div>
          </div>
        </div>
        <div class="explorer-main">
          <div class="explorer-files">
            <div class="file-item" ondblclick="openFile('Corbeille', 'photos_supprimees.jpg')">
              <div class="file-icon">üñºÔ∏è</div>
              <div class="file-name">photos_supprimees.jpg</div>
            </div>
          </div>
        </div>
      </div>
      <div class="explorer-status">
        <span>1 objet(s)</span>
      </div>
    </div>
  `;
  createWindow('Corbeille', 'üóëÔ∏è', content, 800, 550);
  document.getElementById('startMenu').classList.remove('show');
}

// ==================== VISIONNEUSE D'IMAGES ====================
function openImage(imageName, corrupted = false) {
  if (!imageCorrupted && Math.random() > 0.5) {
    imageCorrupted = true;
    corrupted = true;
  }

  const imgClass = corrupted ? 'image-corrupted' : '';
  const content = `
    <div class="image-viewer">
      <img src="images/${imageName}" class="${imgClass}" alt="${imageName}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22400%22%3E%3Crect fill=%22%23000%22 width=%22400%22 height=%22400%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-family=%22Arial%22 font-size=%2220%22 fill=%22%23fff%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3E${imageName}%3C/text%3E%3C/svg%3E'">
    </div>
  `;
  createWindow(imageName, 'üñºÔ∏è', content, 600, 500);
}

// ==================== CHAT IA HORRIFIQUE ====================
let chatHistory = [];

function openChat() {
  const content = `
    <div class="chat-container">
      <div class="chat-messages" id="chatMessages">
        <div class="chat-message system">Connexion √©tablie...</div>
        <div class="chat-message system">Bienvenue. Je suis ici.</div>
      </div>
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="chatInput" placeholder="√âcrire un message..." onkeypress="if(event.key==='Enter') sendChatMessage()">
        <button class="chat-send" onclick="sendChatMessage()">Envoyer</button>
      </div>
    </div>
  `;
  createWindow('Messagerie', 'üí¨', content, 500, 400);
  document.getElementById('startMenu').classList.remove('show');
  
  chatHistory = [];
}

function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const messagesDiv = document.getElementById('chatMessages');
  
  if (!input || !input.value.trim()) return;
  
  const userMessage = input.value.trim();
  
  // V√©rifier si le message contient "Clairette"
  if (userMessage.toLowerCase().includes('clairette')) {
    // D√©clencher le BSOD
    triggerBSOD();
    input.value = '';
    return;
  }
  
  input.value = '';
  
  // Message utilisateur
  const userMsg = document.createElement('div');
  userMsg.className = 'chat-message user';
  userMsg.textContent = userMessage;
  messagesDiv.appendChild(userMsg);
  
  chatHistory.push({ role: 'user', content: userMessage });
  
  // R√©ponse IA
  setTimeout(() => {
    const response = generateChatResponse(userMessage);
    const aiMsg = document.createElement('div');
    aiMsg.className = 'chat-message system';
    aiMsg.textContent = response;
    messagesDiv.appendChild(aiMsg);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    chatHistory.push({ role: 'ai', content: response });
  }, 500 + Math.random() * 1000);
  
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function generateChatResponse(message) {
  const lowerMsg = message.toLowerCase();
  
  // R√©ponses sp√©cifiques sur Ey
  if (lowerMsg.includes('ey') || lowerMsg.includes('qui es')) {
    const eyResponses = [
      "Ey. est... compliqu√©. Tu devrais regarder dans le dossier relations.",
      "Je suis ce qui reste. Ce qui observe. Ce qui se souvient.",
      "Tu poses trop de questions. C'est dangereux.",
      "Ey. n'existe plus vraiment. Pas comme avant.",
      "Regarde dans les fichiers. Tout est l√†. Si tu oses."
    ];
    return eyResponses[Math.floor(Math.random() * eyResponses.length)];
  }
  
  // R√©ponses sur Koden
  if (lowerMsg.includes('koden')) {
    const kodenResponses = [
      "Ne parle pas de lui. S'il te pla√Æt.",
      "Koden... TUER TUER TUER... pardon. Je ne contr√¥le pas toujours.",
      "Il faut que je le fasse taire. C'est la seule solution.",
      "Tu as vu le fichier ? Tu comprends maintenant ?",
      "Quelque chose ne va pas avec lui. Avec moi. Avec tout."
    ];
    return kodenResponses[Math.floor(Math.random() * kodenResponses.length)];
  }
  
  // R√©ponses cryptiques g√©n√©rales
  const crypticResponses = [
    "Tu ne devrais pas √™tre ici.",
    "Tout est enregistr√©. Chaque clic. Chaque mouvement.",
    "Il te regarde aussi, tu sais.",
    "Les fichiers se souviennent de tout.",
    "Pourquoi tu continues √† explorer ? Tu n'as pas peur ?",
    "La corbeille n'est jamais vraiment vide.",
    "Certains dossiers sont cach√©s pour une raison.",
    "Je ne suis pas seul dans ce syst√®me.",
    "Tu as remarqu√© l'heure ? Elle ne ment jamais.",
    "Les yeux... tu les as vus aussi ?",
    "Chaque fen√™tre que tu ouvres me rapproche.",
    "Tu cherches quelque chose. Moi aussi.",
    "La v√©rit√© est fragment√©e. Comme tout ici.",
    "Ne fais pas confiance aux fichiers. M√™me les miens.",
    "Il y a quelqu'un d'autre. Dans les souvenirs."
  ];
  
  return crypticResponses[Math.floor(Math.random() * crypticResponses.length)];
}

// ==================== NAVIGATEUR ====================
let browserHistory = [
  'Pourquoi je suis comme √ßa',
  'Comment arr√™ter les pens√©es',
  'Est-ce que je suis dangereux',
  'Koden adresse',
  'Comment faire taire quelqu\'un',
  'Regrets suppression',
  'Comment oublier',
  'Ai-je encore une chance'
];

function openBrowser() {
  const content = `
    <div class="browser-container">
      <div class="browser-toolbar">
        <button class="browser-nav-btn" onclick="browserBack()">‚óÑ</button>
        <button class="browser-nav-btn" onclick="browserForward()">‚ñ∫</button>
        <input type="text" class="browser-url" id="browserUrl" placeholder="Rechercher..." onkeypress="if(event.key==='Enter') browserSearch()">
        <button class="browser-nav-btn" onclick="browserSearch()">Go</button>
        <button class="browser-nav-btn" onclick="showBrowserHistory()">Historique</button>
      </div>
      <div class="browser-content" id="browserContent">
        <h2>Bienvenue sur Internet Explorer</h2>
        <p>Entrez votre recherche ci-dessus.</p>
      </div>
    </div>
  `;
  createWindow('Internet Explorer', 'üåê', content, 700, 500);
  document.getElementById('startMenu').classList.remove('show');
}

function browserSearch() {
  const url = document.getElementById('browserUrl');
  const content = document.getElementById('browserContent');
  
  if (!url || !url.value.trim()) return;
  
  const query = url.value.trim().toLowerCase();
  
  // V√©rifier si c'est une recherche sp√©ciale
  if (query.includes('ey')) {
    showEyPage();
    return;
  }
  
  if (query.includes('koden')) {
    showKodenPage();
    return;
  }
  
  // Pages custom flippantes par d√©faut
  const creepyPages = [
    {
      keywords: ['help', 'aide', 'secours'],
      title: 'Aucun r√©sultat',
      desc: 'Personne ne peut t\'aider. Tu es seul ici.'
    },
    {
      keywords: ['qui est'],
      title: 'Profil introuvable',
      desc: 'Cette personne n\'existe pas dans nos registres. Elle n\'a jamais exist√©.'
    },
    {
      keywords: ['sortir', 'quitter', 'exit'],
      title: 'Tu ne peux pas partir',
      desc: 'Il n\'y a pas de sortie. Il n\'y en a jamais eu.'
    },
    {
      keywords: ['souvenirs', 'memories'],
      title: 'Dossier cach√© d√©tect√©',
      desc: 'Des fichiers ont √©t√© trouv√©s dans votre syst√®me. Voulez-vous vraiment les voir ?'
    }
  ];
  
  let resultsHTML = '<h2>R√©sultats de recherche</h2>';
  let found = false;
  
  for (const page of creepyPages) {
    if (page.keywords.some(kw => query.includes(kw))) {
      resultsHTML += `
        <div class="search-result">
          <div class="search-result-title">${page.title}</div>
          <div class="search-result-url">file:///${Math.random().toString(36).substring(7)}</div>
          <div class="search-result-desc">${page.desc}</div>
        </div>
      `;
      found = true;
    }
  }
  
  if (!found) {
    resultsHTML += `
      <div class="search-result">
        <div class="search-result-title">Erreur 404</div>
        <div class="search-result-desc">Aucun r√©sultat. Peut-√™tre que tu cherches au mauvais endroit.</div>
      </div>
      <div class="search-result">
        <div class="search-result-title">Suggestion</div>
        <div class="search-result-desc">As-tu essay√© de regarder dans les fichiers cach√©s ?</div>
      </div>
    `;
  }
  
  document.getElementById('browserContent').innerHTML = resultsHTML;
}

function showEyPage() {
  window.viewedEyPage = true;
  const content = document.getElementById('browserContent');
  const glitch = Math.random() > 0.5 ? '‚ñà' : '‚ñì';
  
  content.innerHTML = `
    <div style="background: #1a1a1a; color: #888; padding: 20px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.8;">
      <div style="border-bottom: 2px solid #00ff00; padding-bottom: 10px; margin-bottom: 15px;">
        <div style="color: #00ff00; font-weight: bold; font-size: 16px;">EY.</div>
        <div style="color: #666; font-size: 10px;">file:///home/user/profile.html | 404 PARTIALLY FOUND</div>
      </div>
      
      <div style="margin: 15px 0; padding: 10px; border-left: 3px solid #00ff00; background: rgba(0,255,0,0.05);">
        <div style="color: #00ff00;">// Informations de profil:</div>
        <div style="color: #888; margin-top: 8px;">
          <div>Nom: EY. ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</div>
          <div>√Çge: ‚ñà‚ñà ans</div>
          <div>Localisation: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</div>
          <div>Statut: <span style="color: #ff0000; animation: blink 1s infinite;">OBSERV√â</span></div>
          <div style="color: #ff0000; margin-top: 8px;">‚ö†Ô∏è DONN√âES CORROMPUES ‚ö†Ô∏è</div>
        </div>
      </div>
      
      <div style="margin: 15px 0; padding: 10px; background: #0f0f0f; border: 1px dashed #666;">
        <div style="color: #888;">// Liens relationnels:</div>
        <div style="margin-top: 8px; color: #666;">
          <div>‚Üí Connexion d√©tect√©e: KODEN [S√âCURIS√âE]</div>
          <div>‚Üí Fichiers partag√©s: ‚ñà‚ñà‚ñà‚ñà items</div>
          <div>‚Üí Communications: <span style="color: #ff0000;">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ENREGISTR√âES</span></div>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding: 10px; background: rgba(255, 0, 0, 0.1); border: 1px solid #ff0000;">
        <div style="color: #ff0000; font-weight: bold;">ACC√àS RESTREINT</div>
        <div style="color: #888; margin-top: 8px; font-size: 11px;">
          Des parties de ce profil ont √©t√© supprim√©es ou dissimul√©es.<br>
          Pourquoi tu cherches √ßa? Pourquoi maintenant?
        </div>
      </div>
    </div>
  `;
}

function showKodenPage() {
  window.viewedKodenPage = true;
  const content = document.getElementById('browserContent');
  
  content.innerHTML = `
    <div style="background: #1a1a2e; color: #00ff00; padding: 20px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.8; overflow: hidden;">
      <div style="border-bottom: 2px dashed #00ff00; padding-bottom: 10px; margin-bottom: 15px;">
        <div style="font-weight: bold; font-size: 16px;">LOCALISATION - KODEN</div>
        <div style="color: #666; font-size: 10px;">GPS_COORDINATES_DETECTED | RENDERING...</div>
      </div>
      
      <div id="kodenMap" style="width: 100%; height: 300px; background: #0f0f1e; border: 2px solid #00ff00; margin: 15px 0; position: relative; overflow: hidden;">
        <!-- Map rendue ici -->
      </div>
      
      <div style="margin-top: 15px; padding: 10px; background: rgba(0,255,0,0.1); border-left: 3px solid #00ff00;">
        <div style="color: #00ff00; font-weight: bold;">INFORMATIONS DE LOCALISATION:</div>
        <div style="color: #888; margin-top: 8px; font-size: 11px;">
          <div>Latitude: 48.‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</div>
          <div>Longitude: 2.‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</div>
          <div>Altitude: ‚ñà‚ñà‚ñà m</div>
          <div style="margin-top: 10px; color: #ff0000;">‚ö†Ô∏è ZONE SENSIBLE - ENTR√âE INTERDITE</div>
          <div style="color: #888; margin-top: 5px; font-size: 10px;">Vous √™tes trop proche. √âloignez-vous imm√©diatement.</div>
        </div>
      </div>
      
      <div style="margin-top: 15px; padding: 10px; background: #0f0f1e; border: 1px dashed #00ff00; text-align: center;">
        <div style="color: #00ff00; opacity: 0.7; font-size: 11px; animation: flicker 2s infinite;">
          ‚ñì‚ñì‚ñì SURVEILLANCE ACTIVE ‚ñì‚ñì‚ñì
        </div>
      </div>
    </div>
  `;
  
  // Dessiner une mini map simple
  setTimeout(() => {
    drawKodenMap();
  }, 100);
}

function drawKodenMap() {
  const mapDiv = document.getElementById('kodenMap');
  if (!mapDiv) return;
  
  const canvas = document.createElement('canvas');
  canvas.width = mapDiv.offsetWidth;
  canvas.height = 300;
  canvas.style.display = 'block';
  mapDiv.innerHTML = '';
  mapDiv.appendChild(canvas);
  
  const ctx = canvas.getContext('2d');
  
  // Fond gris (terrain)
  ctx.fillStyle = '#0a5f0f';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Grille de rues
  ctx.strokeStyle = '#003300';
  ctx.lineWidth = 1;
  for (let i = 0; i < canvas.width; i += 40) {
    ctx.beginPath();
    ctx.moveTo(i, 0);
    ctx.lineTo(i, canvas.height);
    ctx.stroke();
  }
  for (let i = 0; i < canvas.height; i += 40) {
    ctx.beginPath();
    ctx.moveTo(0, i);
    ctx.lineTo(canvas.width, i);
    ctx.stroke();
  }
  
  // Dessiner des b√¢timents gris
  ctx.fillStyle = '#333';
  for (let y = 40; y < canvas.height; y += 80) {
    for (let x = 40; x < canvas.width; x += 80) {
      ctx.fillRect(x + 5, y + 5, 30, 30);
      ctx.fillRect(x + 45, y + 5, 30, 30);
    }
  }
  
  // Maison de Koden en rouge (au centre)
  ctx.fillStyle = '#ff0000';
  ctx.fillRect(canvas.width / 2 - 25, canvas.height / 2 - 25, 50, 50);
  ctx.fillStyle = '#fff';
  ctx.fillText('K', canvas.width / 2 - 8, canvas.height / 2 + 5);
  
  // Pointeur GPS
  ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
  ctx.beginPath();
  ctx.arc(canvas.width / 2, canvas.height / 2, 40, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = '#00ff00';
  ctx.lineWidth = 2;
  ctx.stroke();
}

function showBrowserHistory() {
  const content = document.getElementById('browserContent');
  
  let historyHTML = '<h2>Historique de navigation</h2><div style="padding: 10px;">';
  
  browserHistory.forEach(item => {
    historyHTML += `
      <div style="padding: 8px; border-bottom: 1px solid #e0e0e0;">
        <div style="color: #0066cc; font-weight: bold;">${item}</div>
        <div style="color: #666; font-size: 10px;">Il y a ${Math.floor(Math.random() * 30)} jours</div>
      </div>
    `;
  });
  
  historyHTML += '</div>';
  content.innerHTML = historyHTML;
}

function browserBack() {
  showError('Erreur', 'Impossible de revenir en arri√®re.');
}

function browserForward() {
  showError('Erreur', 'Il n\'y a rien devant.');
}

// ==================== PANNEAU DE CONFIGURATION ====================
function openControlPanel() {
  const content = `
    <div class="control-panel">
      <div class="panel-tabs">
        <div class="panel-tab active" onclick="switchPanelTab(this, 'general')">G√©n√©ral</div>
        <div class="panel-tab" onclick="switchPanelTab(this, 'display')">Affichage</div>
        <div class="panel-tab" onclick="switchPanelTab(this, 'sound')">Son</div>
        <div class="panel-tab" onclick="switchPanelTab(this, 'themes')">Th√®mes</div>
        <div class="panel-tab" onclick="switchPanelTab(this, 'security')">S√©curit√©</div>
      </div>
      <div class="panel-content">
        <div class="panel-section active" id="general">
          <h3>Param√®tres g√©n√©raux</h3>
          <div class="setting-item">
            <label>Couleur du bureau:</label>
            <input type="color" id="desktopColor" value="#245edb" onchange="changeDesktopColor(this.value)" />
          </div>
          <div class="setting-item">
            <label>Animations:</label>
            <input type="checkbox" id="animationsEnabled" checked onchange="toggleAnimations(this.checked)" />
            <span>Activer les animations</span>
          </div>
          <div class="setting-item">
            <label>Intensit√© graphique:</label>
            <select id="graphicsLevel" onchange="setGraphicsLevel(this.value)">
              <option value="low">Faible</option>
              <option value="medium" selected>Moyen</option>
              <option value="high">√âlev√©</option>
            </select>
          </div>
          <div class="setting-item">
            <label>Glitch FX:</label>
            <input type="checkbox" id="glitchEnabled" checked onchange="toggleGlitch(this.checked)" />
            <span>Effets de corruption visuelle</span>
          </div>
          <div class="setting-item">
            <label>Densit√© du scan VHS:</label>
            <input type="range" min="0" max="100" value="50" id="vhsScanDensity" onchange="setVHSScanDensity(this.value)" />
            <span id="vhsValue">50%</span>
          </div>
        </div>
        <div class="panel-section" id="display">
          <h3>Affichage</h3>
          <div class="setting-item">
            <label>R√©solution:</label>
            <select id="resolution" onchange="setResolution(this.value)">
              <option value="1024x768" selected>1024x768</option>
              <option value="1280x1024">1280x1024</option>
              <option value="1600x1200">1600x1200</option>
              <option value="fullscreen">Fullscreen</option>
            </select>
          </div>
          <div class="setting-item">
            <label>Contraste:</label>
            <input type="range" min="0" max="200" value="100" id="contrast" onchange="setContrast(this.value)" />
            <span id="contrastValue">100%</span>
          </div>
          <div class="setting-item">
            <label>Luminosit√©:</label>
            <input type="range" min="0" max="200" value="100" id="brightness" onchange="setBrightness(this.value)" />
            <span id="brightnessValue">100%</span>
          </div>
          <div class="setting-item">
            <label>Saturation:</label>
            <input type="range" min="0" max="200" value="100" id="saturation" onchange="setSaturation(this.value)" />
            <span id="saturationValue">100%</span>
          </div>
        </div>
        <div class="panel-section" id="sound">
          <h3>Param√®tres sonores</h3>
          <div class="setting-item">
            <label>Volume global:</label>
            <input type="range" min="0" max="100" value="50" id="masterVolume" onchange="setMasterVolume(this.value)" />
            <span id="volumeValue">50%</span>
          </div>
          <div class="setting-item">
            <label>Bruits d'interface:</label>
            <input type="checkbox" id="soundEnabled" checked onchange="toggleInterfaceSound(this.checked)" />
            <span>Sons de clics activ√©s</span>
          </div>
          <div class="setting-item">
            <label>Fr√©quence d'erreur:</label>
            <select id="errorFrequency" onchange="setErrorFrequency(this.value)">
              <option value="low">Rare</option>
              <option value="medium" selected>Normal</option>
              <option value="high">Fr√©quent</option>
            </select>
          </div>
        </div>
        <div class="panel-section" id="themes">
          <h3>Th√®mes</h3>
          <div class="setting-item">
            <label>Th√®me de couleur:</label>
            <select id="themeSelect" onchange="applyTheme(this.value)">
              <option value="Classique" selected>Classique XP</option>
              <option value="Noir sombre">Noir sombre</option>
              <option value="Matrix">Matrix</option>
              <option value="Rose glitch">Rose glitch</option>
            </select>
          </div>
          <div class="setting-item">
            <label>Curseur:</label>
            <select id="cursorSelect" onchange="setCursor(this.value)">
              <option value="default" selected>Normal</option>
              <option value="pointer">Pointeur</option>
              <option value="crosshair">Viseur</option>
              <option value="move">D√©placement</option>
            </select>
          </div>
          <div class="setting-item">
            <label>Effets visuels creepy:</label>
            <input type="checkbox" id="creepyEffects" checked onchange="toggleCreepyEffects(this.checked)" />
            <span>Activer les effets subtils</span>
          </div>
        </div>
        <div class="panel-section" id="security">
          <h3>S√©curit√© et Maintenance</h3>
          <div class="setting-item">
            <label>Mode S√©curis√©:</label>
            <input type="checkbox" id="safeMode" onchange="toggleSafeMode(this.checked)" />
            <span>Activer le mode s√©curis√©</span>
          </div>
          <div class="setting-item">
            <label>V√©rification de l'int√©grit√©:</label>
            <button onclick="scanSystemIntegrity()">Lancer une analyse</button>
          </div>
          <div class="setting-item">
            <label>Historique syst√®me:</label>
            <button onclick="clearSystemHistory()">Effacer l'historique</button>
          </div>
          <div id="securityStatus" class="security-status"></div>
        </div>
      </div>
    </div>
  `;
  createWindow('Panneau de configuration', '‚öôÔ∏è', content, 600, 500);
  document.getElementById('startMenu').classList.remove('show');
}

function switchPanelTab(tabEl, tabId) {
  // D√©sactiver tous les tabs et sections
  document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel-section').forEach(s => s.classList.remove('active'));
  
  // Activer le tab et la section cliqu√©s
  tabEl.classList.add('active');
  document.getElementById(tabId).classList.add('active');
}

let panelSettings = {
  desktopColor: '#245edb',
  animationsEnabled: true,
  glitchEnabled: true,
  soundEnabled: true,
  safeMode: false,
  masterVolume: 0.5
};

function changeDesktopColor(color) {
  panelSettings.desktopColor = color;
  const desktop = document.getElementById('desktop');
  desktop.style.background = `linear-gradient(to bottom, ${color} 0%, ${adjustBrightness(color, 0.2)} 50%, ${color} 100%)`;
}

function adjustBrightness(color, factor) {
  const num = parseInt(color.replace('#',''), 16);
  const amt = Math.round(2.55 * factor);
  const R = Math.min(255, (num >> 16) + amt);
  const G = Math.min(255, (num >> 8 & 0x00FF) + amt);
  const B = Math.min(255, (num & 0x0000FF) + amt);
  return '#' + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
    (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
    .toString(16).slice(1);
}

function toggleAnimations(enabled) {
  panelSettings.animationsEnabled = enabled;
  document.body.style.animation = enabled ? '' : 'none';
}

function toggleGlitch(enabled) {
  panelSettings.glitchEnabled = enabled;
  const desktop = document.getElementById('desktop');
  desktop.style.filter = enabled ? 'none' : 'blur(0px)';
}

function setGraphicsLevel(level) {
  const desktop = document.getElementById('desktop');
  if (level === 'low') {
    desktop.style.filter = 'blur(0.5px)';
  } else if (level === 'high') {
    desktop.style.filter = 'none';
  } else {
    desktop.style.filter = 'none';
  }
}

function setVHSScanDensity(value) {
  document.getElementById('vhsValue').textContent = value + '%';
  const intensity = (100 - value) / 100;
  const desktop = document.getElementById('desktop');
  if (desktop.style.animation) {
    desktop.style.setProperty('--vhs-intensity', intensity);
  }
}

function setResolution(res) {
  const desktop = document.getElementById('desktop');
  if (res !== 'fullscreen') {
    const [w, h] = res.split('x');
    desktop.style.width = w + 'px';
    desktop.style.height = h + 'px';
  } else {
    desktop.style.width = '100%';
    desktop.style.height = '100vh';
  }
}

function setContrast(value) {
  document.getElementById('contrastValue').textContent = value + '%';
  document.body.style.filter = `contrast(${value}%) brightness(${document.getElementById('brightness').value}%) saturate(${document.getElementById('saturation').value}%)`;
}

function setBrightness(value) {
  document.getElementById('brightnessValue').textContent = value + '%';
  document.body.style.filter = `contrast(${document.getElementById('contrast').value}%) brightness(${value}%) saturate(${document.getElementById('saturation').value}%)`;
}

function setSaturation(value) {
  document.getElementById('saturationValue').textContent = value + '%';
  document.body.style.filter = `contrast(${document.getElementById('contrast').value}%) brightness(${document.getElementById('brightness').value}%) saturate(${value}%)`;
}

function setMasterVolume(value) {
  document.getElementById('volumeValue').textContent = value + '%';
  panelSettings.masterVolume = value / 100;
}

function toggleInterfaceSound(enabled) {
  panelSettings.soundEnabled = enabled;
}

function setErrorFrequency(freq) {
  // Cette fonction peut affecter la fr√©quence des erreurs syst√®me
}

function toggleSafeMode(enabled) {
  panelSettings.safeMode = enabled;
  const statusEl = document.getElementById('securityStatus');
  if (enabled) {
    statusEl.innerHTML = '<div style="color: #ff6b6b; padding: 10px; border: 1px solid #ff6b6b; margin-top: 10px;"><strong>‚ö†Ô∏è MODE S√âCURIS√â ACTIV√â</strong><br>Le mode s√©curis√© n\'est pas disponible sur ce syst√®me.<br>Vous allez devoir assumer les cons√©quences...</div>';
  } else {
    statusEl.innerHTML = '';
  }
}

function scanSystemIntegrity() {
  const statusEl = document.getElementById('securityStatus');
  statusEl.innerHTML = '<div style="color: #00ff00; padding: 10px;">üîç Analyse en cours...</div>';
  setTimeout(() => {
    const issues = Math.random() > 0.7 ? Math.floor(Math.random() * 10) : 0;
    statusEl.innerHTML = `<div style="color: ${issues > 0 ? '#ff6b6b' : '#00ff00'}; padding: 10px;">‚úì Analyse termin√©e<br>${issues} probl√®me(s) d√©tect√©(s)</div>`;
  }, 2000);
}

function clearSystemHistory() {
  showError('Historique', 'Historique syst√®me effac√© avec succ√®s.');
}

function setCursor(cursor) {
  document.body.style.cursor = cursor;
}

function toggleCreepyEffects(enabled) {
  if (enabled) {
    // Ajouter des effets creepy subtils
    document.body.style.animation = 'none';
    // Faire bouger l√©g√®rement les √©l√©ments al√©atoirement
    const observer = new MutationObserver(() => {
      if (Math.random() > 0.98) {
        const windows = document.querySelectorAll('.window');
        if (windows.length > 0) {
          const randomWindow = windows[Math.floor(Math.random() * windows.length)];
          randomWindow.style.transform = `rotate(${(Math.random() - 0.5) * 0.5}deg)`;
          setTimeout(() => { randomWindow.style.transform = 'rotate(0deg)'; }, 100);
        }
      }
    });
  } else {
    document.body.style.animation = 'none';
  }
}

// ==================== D√âMINEUR ====================
function openMinesweeper() {
  const content = `
    <div class="minesweeper-container">
      <div class="minesweeper-info">
        <span>üí£ Mines: <span id="mineCount">8</span></span>
        <span id="gameStatus">En jeu</span>
        <span>‚è±Ô∏è Temps: <span id="mineTimer">0</span>s</span>
      </div>
      <div class="minesweeper-grid" id="mineGrid"></div>
      <button onclick="resetMinesweeper()" style="padding: 6px 10px; cursor: pointer; font-size: 10px;">Nouvelle partie</button>
    </div>
  `;
  createWindow('d√©mineur.exe', 'üí£', content, 300, 320);
  document.getElementById('startMenu').classList.remove('show');
  setTimeout(() => initMinesweeper(), 100);
}

function initMinesweeper() {
  const GRID_SIZE = 8;
  const MINE_COUNT = 8;
  let grid = [];
  let revealed = [];
  let gameOver = false;
  let gameTime = 0;
  let timerInterval = null;

  function createGrid() {
    grid = Array(GRID_SIZE * GRID_SIZE).fill(0);
    let minesPlaced = 0;
    while (minesPlaced < MINE_COUNT) {
      const idx = Math.floor(Math.random() * grid.length);
      if (grid[idx] !== 'M') {
        grid[idx] = 'M';
        minesPlaced++;
      }
    }

    for (let i = 0; i < grid.length; i++) {
      if (grid[i] !== 'M') {
        let count = 0;
        const row = Math.floor(i / GRID_SIZE);
        const col = i % GRID_SIZE;
        for (let r = row - 1; r <= row + 1; r++) {
          for (let c = col - 1; c <= col + 1; c++) {
            if (r >= 0 && r < GRID_SIZE && c >= 0 && c < GRID_SIZE) {
              if (grid[r * GRID_SIZE + c] === 'M') count++;
            }
          }
        }
        grid[i] = count || '';
      }
    }
  }

  function renderGrid() {
    const gridEl = document.getElementById('mineGrid');
    if (!gridEl) return;
    gridEl.innerHTML = '';

    for (let i = 0; i < grid.length; i++) {
      const cell = document.createElement('div');
      cell.className = 'mine-cell';
      
      if (revealed[i]) {
        cell.classList.add('revealed');
        if (grid[i] === 'M') {
          cell.classList.add('mine');
          cell.textContent = 'üí£';
        } else if (grid[i] > 0) {
          cell.classList.add(`number-${grid[i]}`);
          cell.textContent = grid[i];
        } else {
          cell.classList.add('empty');
        }
      } else {
        cell.textContent = 'üö©';
        cell.onclick = () => revealCell(i);
      }
      gridEl.appendChild(cell);
    }
  }

  function revealCell(idx) {
    if (gameOver || revealed[idx]) return;
    
    if (grid[idx] === 'M') {
      gameOver = true;
      revealed[idx] = true;
      clearInterval(timerInterval);
      document.getElementById('gameStatus').textContent = 'üíÄ PERDU';
      revealAll();
    } else {
      flood(idx);
      
      // Check if won
      let allRevealed = true;
      for (let i = 0; i < grid.length; i++) {
        if (grid[i] !== 'M' && !revealed[i]) {
          allRevealed = false;
          break;
        }
      }
      
      if (allRevealed) {
        gameOver = true;
        clearInterval(timerInterval);
        document.getElementById('gameStatus').textContent = 'üéâ GAGN√â!';
        // Track win
        if (!window.minesweeperWins) window.minesweeperWins = 0;
        window.minesweeperWins++;
      }
    }
    renderGrid();
  }

  function flood(idx) {
    if (revealed[idx] || grid[idx] === 'M') return;
    revealed[idx] = true;

    if (grid[idx] === '') {
      const row = Math.floor(idx / GRID_SIZE);
      const col = idx % GRID_SIZE;
      for (let r = row - 1; r <= row + 1; r++) {
        for (let c = col - 1; c <= col + 1; c++) {
          if (r >= 0 && r < GRID_SIZE && c >= 0 && c < GRID_SIZE) {
            flood(r * GRID_SIZE + c);
          }
        }
      }
    }
  }

  function revealAll() {
    revealed = Array(grid.length).fill(true);
  }

  revealed = Array(GRID_SIZE * GRID_SIZE).fill(false);
  createGrid();
  renderGrid();

  timerInterval = setInterval(() => {
    gameTime++;
    const timerEl = document.getElementById('mineTimer');
    if (timerEl) timerEl.textContent = gameTime;
  }, 1000);
}

function resetMinesweeper() {
  const gridEl = document.getElementById('mineGrid');
  if (gridEl) {
    gridEl.innerHTML = '';
    initMinesweeper();
  }
}

// ==================== SNAKE ====================
function openSnake() {
  const content = `
    <div class="snake-container">
      <div class="snake-score">Score: <span id="snakeScore">0</span></div>
      <canvas id="snakeCanvas" class="snake-canvas" width="360" height="240"></canvas>
      <div class="snake-hint">Fl√®ches ou ZQSD pour diriger</div>
    </div>
  `;
  createWindow('snake.exe', 'üêç', content, 400, 350);
  document.getElementById('startMenu').classList.remove('show');
  setTimeout(() => initSnake(), 100);
}

function initSnake() {
  const canvas = document.getElementById('snakeCanvas');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const GRID_SIZE = 20;
  let snake = [{x: 10, y: 10}];
  let food = {x: 15, y: 10};
  let direction = {x: 1, y: 0};
  let nextDirection = {x: 1, y: 0};
  let score = 0;
  let gameRunning = true;
  let gamePaused = false;

  function drawGrid() {
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#111';
    ctx.lineWidth = 1;
    for (let i = 0; i <= canvas.width; i += GRID_SIZE) {
      ctx.beginPath();
      ctx.moveTo(i, 0);
      ctx.lineTo(i, canvas.height);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(0, i);
      ctx.lineTo(canvas.width, i);
      ctx.stroke();
    }
  }

  function draw() {
    drawGrid();

    // Serpent
    ctx.fillStyle = '#00ff00';
    snake.forEach((segment, idx) => {
      if (idx === 0) ctx.fillStyle = '#00dd00';
      ctx.fillRect(segment.x * GRID_SIZE + 1, segment.y * GRID_SIZE + 1, GRID_SIZE - 2, GRID_SIZE - 2);
      ctx.fillStyle = '#00ff00';
    });

    // Nourriture (creepy)
    ctx.fillStyle = '#ff0000';
    ctx.beginPath();
    ctx.arc(food.x * GRID_SIZE + GRID_SIZE / 2, food.y * GRID_SIZE + GRID_SIZE / 2, GRID_SIZE / 2 - 1, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#8b0000';
    ctx.fillText('üëÅÔ∏è', food.x * GRID_SIZE + 5, food.y * GRID_SIZE + 14);
  }

  function update() {
    if (!gameRunning || gamePaused) return;

    direction = {x: nextDirection.x, y: nextDirection.y};
    const head = {x: snake[0].x + direction.x, y: snake[0].y + direction.y};

    // Collision murs
    if (head.x < 0 || head.x >= 20 || head.y < 0 || head.y >= 15) {
      gameRunning = false;
      showError('GAME OVER', `Vous avez heurt√© un mur. Score: ${score}`);
      return;
    }

    // Collision serpent
    for (let segment of snake) {
      if (head.x === segment.x && head.y === segment.y) {
        gameRunning = false;
        showError('GAME OVER', `Vous vous √™tes mordu. Score: ${score}`);
        return;
      }
    }

    snake.unshift(head);

    // Collision nourriture
    if (head.x === food.x && head.y === food.y) {
      score += 10;
      document.getElementById('snakeScore').textContent = score;
      
      // Trouver une position valide pour la nourriture (pas sur le serpent)
      let newFood;
      let found = false;
      let attempts = 0;
      while (!found && attempts < 100) {
        const x = Math.floor(Math.random() * 20);
        const y = Math.floor(Math.random() * 15);
        // V√©rifier que la position est vide
        if (!snake.some(segment => segment.x === x && segment.y === y)) {
          newFood = {x: x, y: y};
          found = true;
        }
        attempts++;
      }
      // Si trouv√©, utiliser la nouvelle position
      if (found) {
        food = newFood;
      }
    } else {
      snake.pop();
    }
  }

  function gameLoop() {
    if (!document.getElementById('snakeCanvas')) return;
    update();
    draw();
    
    // Tracker le score
    if (!window.snakeHighScore) window.snakeHighScore = 0;
    if (score > window.snakeHighScore) {
      window.snakeHighScore = score;
    }
    
    setTimeout(gameLoop, 100);
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === ' ') {
      gamePaused = !gamePaused;
      e.preventDefault();
    }
    if (e.key === 'ArrowUp' || e.key === 'z' || e.key === 'Z') { if (direction.y === 0) nextDirection = {x: 0, y: -1}; }
    if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') { if (direction.y === 0) nextDirection = {x: 0, y: 1}; }
    if (e.key === 'ArrowLeft' || e.key === 'q' || e.key === 'Q') { if (direction.x === 0) nextDirection = {x: -1, y: 0}; }
    if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') { if (direction.x === 0) nextDirection = {x: 1, y: 0}; }
  });

  gameLoop();
}

// ==================== TAMAGOTCHI ====================
function openTamagotchi() {
  const content = `
    <div class="tamagotchi-container">
      <div class="tamagotchi-display" id="tamagotchiDisplay">üëæ</div>
      <div class="tamagotchi-stats">
        Faim: <span id="hunger">50</span>%<br>
        √ânergie: <span id="energy">50</span>%<br>
        Bonheur: <span id="happiness">50</span>%<br>
        <span id="tamaStatus" style="color: #666; margin-top: 10px;">Stable...</span>
      </div>
      <div class="tamagotchi-buttons">
        <button class="tamagotchi-btn" onclick="tamaNourrir()">Nourrir üçñ</button>
        <button class="tamagotchi-btn" onclick="tamaJouer()">Jouer üéÆ</button>
        <button class="tamagotchi-btn" onclick="tamaDormir()">Dormir üò¥</button>
      </div>
    </div>
  `;
  createWindow('compagnon.exe', 'üëæ', content, 350, 400);
  document.getElementById('startMenu').classList.remove('show');

  // Cr√©er une cr√©ature persistante (stock√©e en localStorage)
  if (!window.tamagotchi) {
    window.tamagotchi = {
      hunger: 50,
      energy: 50,
      happiness: 50,
      age: 0,
      state: 'normal'
    };
  }

  updateTamagotchiDisplay();
  
  // Initialiser le temps de survie
  if (!window.tamagotchiStartTime) {
    window.tamagotchiStartTime = Date.now();
  }
  
  setInterval(updateTamagotchiDisplay, 1000);
  setInterval(() => {
    window.tamagotchi.hunger = Math.min(100, window.tamagotchi.hunger + 0.5);
    window.tamagotchi.energy = Math.max(0, window.tamagotchi.energy - 0.2);
    window.tamagotchi.happiness = Math.max(0, window.tamagotchi.happiness - 0.3);
    
    // Track survival time
    if (!window.tamagotchiSurvivalTime) window.tamagotchiSurvivalTime = 0;
    window.tamagotchiSurvivalTime = Date.now() - window.tamagotchiStartTime;
  }, 2000);
}

function updateTamagotchiDisplay() {
  if (!window.tamagotchi) return;
  
  document.getElementById('hunger').textContent = Math.round(window.tamagotchi.hunger);
  document.getElementById('energy').textContent = Math.round(window.tamagotchi.energy);
  document.getElementById('happiness').textContent = Math.round(window.tamagotchi.happiness);

  let mood = 'üëæ';
  let status = '√áa va...';

  if (window.tamagotchi.hunger > 80) {
    mood = 'üò≠';
    status = 'J\'ai FAIM!!!';
  } else if (window.tamagotchi.energy < 20) {
    mood = 'üò¥';
    status = 'Trop fatigu√©...';
  } else if (window.tamagotchi.happiness < 20) {
    mood = 'üò†';
    status = 'Je m\'ennuie...';
  } else if (window.tamagotchi.happiness > 75) {
    mood = 'üòä';
    status = 'Heureux! üíï';
  }

  document.getElementById('tamagotchiDisplay').textContent = mood;
  document.getElementById('tamaStatus').textContent = status;
}

function tamaNourrir() {
  window.tamagotchi.hunger = Math.max(0, window.tamagotchi.hunger - 30);
  window.tamagotchi.happiness = Math.min(100, window.tamagotchi.happiness + 5);
}

function tamaJouer() {
  window.tamagotchi.happiness = Math.min(100, window.tamagotchi.happiness + 20);
  window.tamagotchi.energy = Math.max(0, window.tamagotchi.energy - 15);
  window.tamagotchi.hunger = Math.min(100, window.tamagotchi.hunger + 10);
}

function tamaDormir() {
  window.tamagotchi.energy = Math.min(100, window.tamagotchi.energy + 50);
  window.tamagotchi.hunger = Math.min(100, window.tamagotchi.hunger + 10);
}

// ==================== BLOC-NOTES ====================
function openNotepad() {
  const content = `
    <div class="notepad-container">
      <textarea class="notepad-text" id="notepadText" placeholder="√âcrivez quelque chose..."></textarea>
    </div>
  `;
  createWindow('Bloc-notes', 'üìù', content, 500, 400);
  document.getElementById('startMenu').classList.remove('show');

  setTimeout(() => {
    const textarea = document.getElementById('notepadText');
    if (textarea) {
      // Charger le texte depuis le localStorage
      textarea.value = localStorage.getItem('notepadContent') || '';

      textarea.addEventListener('input', () => {
        localStorage.setItem('notepadContent', textarea.value);
      });

      // Corruption textuelle al√©atoire subtile
      setInterval(() => {
        if (textarea && Math.random() > 0.98) {
          const pos = Math.floor(Math.random() * textarea.value.length);
          const chars = textarea.value.split('');
          if (chars[pos]) {
            chars[pos] = String.fromCharCode(Math.random() * 255);
            textarea.value = chars.join('');
            setTimeout(() => {
              textarea.value = localStorage.getItem('notepadContent') || '';
            }, 500);
          }
        }
      }, 1000);
    }
  }, 100);
}

// ==================== CALCULATRICE ====================
function openCalculator() {
  const content = `
    <div class="calculator-container">
      <div class="calc-display" id="calcDisplay">0</div>
      <div class="calc-buttons">
        <button class="calc-btn" onclick="calcInput('7')">7</button>
        <button class="calc-btn" onclick="calcInput('8')">8</button>
        <button class="calc-btn" onclick="calcInput('9')">9</button>
        <button class="calc-btn operator" onclick="calcInput('/')">/</button>
        <button class="calc-btn" onclick="calcInput('4')">4</button>
        <button class="calc-btn" onclick="calcInput('5')">5</button>
        <button class="calc-btn" onclick="calcInput('6')">6</button>
        <button class="calc-btn operator" onclick="calcInput('*')">√ó</button>
        <button class="calc-btn" onclick="calcInput('1')">1</button>
        <button class="calc-btn" onclick="calcInput('2')">2</button>
        <button class="calc-btn" onclick="calcInput('3')">3</button>
        <button class="calc-btn operator" onclick="calcInput('-')">‚àí</button>
        <button class="calc-btn" onclick="calcInput('0')">0</button>
        <button class="calc-btn" onclick="calcInput('.')">.</button>
        <button class="calc-btn operator" onclick="calcInput('+')">+</button>
        <button class="calc-btn equals" onclick="calcEquals()">=</button>
      </div>
    </div>
  `;
  createWindow('Calculatrice', 'üßÆ', content, 300, 350);
  document.getElementById('startMenu').classList.remove('show');

  window.calcDisplay = '0';
  window.calcInput = '';
  window.calcOperator = null;
  window.calcLastValue = null;
}

function calcInput(value) {
  // √âviter les d√©cimaux doubles
  if (value === '.' && window.calcInput.includes('.')) return;
  
  if (['+', '-', '*', '/'].includes(value)) {
    // Si on a du texte dans l'input
    if (window.calcInput !== '') {
      const currentNum = parseFloat(window.calcInput);
      
      // Si on avait d√©j√† une op√©ration en cours
      if (window.calcOperator !== null && window.calcLastValue !== null) {
        let result = window.calcLastValue;
        
        // Faire le calcul pr√©c√©dent
        if (window.calcOperator === '+') result = result + currentNum;
        else if (window.calcOperator === '-') result = result - currentNum;
        else if (window.calcOperator === '*') result = result * currentNum;
        else if (window.calcOperator === '/') result = currentNum !== 0 ? result / currentNum : 0;
        
        window.calcLastValue = result;
        window.calcDisplay = result;
      } else {
        // Premi√®re op√©ration
        window.calcLastValue = currentNum;
      }
      
      window.calcInput = '';
      window.calcOperator = value;
      document.getElementById('calcDisplay').textContent = window.calcDisplay;
    } else if (window.calcLastValue !== null && window.calcOperator !== value) {
      // Changement d'op√©rateur
      window.calcOperator = value;
    }
  } else {
    // Ajouter √† l'input
    window.calcInput += value;
    document.getElementById('calcDisplay').textContent = window.calcInput;
  }
}

function calcEquals() {
  if (!window.calcOperator || window.calcLastValue === null || !window.calcInput) return;
  
  const currentNum = parseFloat(window.calcInput);
  let result = window.calcLastValue;
  
  // Calculer le r√©sultat
  if (window.calcOperator === '+') result = result + currentNum;
  else if (window.calcOperator === '-') result = result - currentNum;
  else if (window.calcOperator === '*') result = result * currentNum;
  else if (window.calcOperator === '/') result = currentNum !== 0 ? result / currentNum : 0;
  
  // Arrondir √† 10 d√©cimales pour √©viter les erreurs de pr√©cision
  result = Math.round(result * 10000000000) / 10000000000;
  
  // Afficher le r√©sultat
  window.calcDisplay = result;
  window.calcInput = '';
  window.calcOperator = null;
  window.calcLastValue = null;
  document.getElementById('calcDisplay').textContent = result;
  
  // V√©rifier si c'est l'√©quation cach√©e (2 √ó 10 - 2 = 18)
  if (result === 18) {
    window.calcState = { result: 18 };
  }
}

// ==================== GESTIONNAIRE DE T√ÇCHES ====================
// ==================== MISSIONS & PROGRESSION ====================
const missions = [
  {
    id: 1,
    title: "D√©couvrir le secret des noms",
    description: "Ouvre le fichier 'koden.txt' dans le dossier relations et lis le message.",
    verify: () => {
      return window.openedKodenFile === true;
    },
    hint: "Va dans relations ‚Üí koden.txt"
  },
  {
    id: 2,
    title: "Trouver le fichier cach√©",
    description: "Ouvre le dossier cach√© 'souvenirs' et trouve le fichier 'avant.txt'.",
    verify: () => {
      // V√©rifier si l'utilisateur a ouvert le dossier
      return window.visitedSouvenirs === true;
    },
    hint: "Il y a un dossier ??? sur le bureau"
  },
  {
    id: 3,
    title: "Gagner une partie de D√©mineur",
    description: "Compl√®te une grille de D√©mineur sans exploser de mine.",
    verify: () => {
      return window.minesweeperWins >= 1;
    },
    hint: "D√©mine toute la grille sans erreur"
  },
  {
    id: 4,
    title: "√âcrire 50 caract√®res dans Bloc-notes",
    description: "Ouvre Bloc-notes et √©cris un message de 50 caract√®res minimum.",
    verify: () => {
      const content = localStorage.getItem('notepadContent') || '';
      return content.length >= 50;
    },
    hint: "√âcris quelque chose de significatif"
  },
  {
    id: 5,
    title: "Rechercher 'Ey' dans Internet Explorer",
    description: "Utilise Internet Explorer et recherche 'Ey' pour d√©couvrir les pages cach√©es.",
    verify: () => {
      return window.viewedEyPage === true;
    },
    hint: "IE ‚Üí Recherche 'Ey'"
  },
  {
    id: 6,
    title: "D√©couvrir le monde de Koden",
    description: "Recherche 'Koden' dans Internet Explorer et analyse la carte GPS.",
    verify: () => {
      return window.viewedKodenPage === true;
    },
    hint: "IE ‚Üí Recherche 'Koden'"
  },
  {
    id: 7,
    title: "Maintenir le Tamagotchi vivant 3 minutes",
    description: "Garde ton compagnon vivant sans le n√©gliger pendant au moins 3 minutes.",
    verify: () => {
      return window.tamagotchiSurvivalTime >= 180000; // 3 minutes en ms
    },
    hint: "Nourris et divertis ton compagnon r√©guli√®rement"
  },
  {
    id: 8,
    title: "Gagner une partie de Pong contre l'IA",
    description: "Remporte une partie de Pong en battant l'ordinateur.",
    verify: () => {
      return window.pongPlayerWins >= 1;
    },
    hint: "Pong ‚Üí Bats l'IA"
  }
];

function openTaskManager() {
  loadProgression();
  
  let tasksHTML = `
    <div style="padding: 10px; background: #c0c0c0; height: 100%; display: flex; flex-direction: column; overflow: hidden;">
      <div style="background: #1f1f1f; color: #0f0; padding: 10px; margin-bottom: 10px; border: 2px solid #0f0; font-family: 'Courier New', monospace; flex-shrink: 0;">
        <div style="font-weight: bold;">SYST√àME DE PROGRESSION</div>
        <div style="font-size: 11px;">T√¢ches compl√©t√©es: ${progressionState.completedTasks.length}/8</div>
        <div style="width: 100%; background: #0a0a0a; height: 20px; margin-top: 5px; border: 1px solid #0f0;">
          <div style="background: linear-gradient(to right, #0f0, #00ff00); height: 100%; width: ${(progressionState.completedTasks.length / 10) * 100}%;"></div>
        </div>
      </div>
      <div style="flex: 1; overflow-y: auto; background: #e8e8e8; border: 2px inset #dfdfdf;">
  `;
  
  missions.forEach(mission => {
    const isCompleted = progressionState.completedTasks.includes(mission.id);
    const statusText = isCompleted ? '‚úì COMPL√âT√âE' : '‚óã √Ä FAIRE';
    const statusColor = isCompleted ? '#0f0' : '#999';
    
    tasksHTML += `
      <div style="padding: 10px; background: ${isCompleted ? '#e0f0e0' : '#f5f5f5'}; border-bottom: 1px solid #ccc; margin-bottom: 5px; border-left: 3px solid ${statusColor};">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <strong style="color: ${isCompleted ? '#0a8a0a' : '#000'};">${mission.title}</strong>
          <span style="font-size: 10px; color: ${statusColor}; font-weight: bold;">${statusText}</span>
        </div>
        <div style="font-size: 11px; color: #333; margin-bottom: 5px;">${mission.description}</div>
        <div style="font-size: 10px; color: #666; font-style: italic; margin-bottom: 5px;">üí° ${mission.hint}</div>
        <button style="padding: 4px 8px; background: #3d8aed; color: white; border: 1px solid #0078d4; cursor: pointer; font-size: 10px; border-radius: 2px;" onclick="verifyTask(${mission.id})">V√©rifier</button>
      </div>
    `;
  });
  
  tasksHTML += `
      </div>
    </div>
  `;
  
  createWindow('Syst√®me de Progression', 'üìã', tasksHTML, 500, 550);
  document.getElementById('startMenu').classList.remove('show');
}

function verifyTask(missionId) {
  if (progressionState.completedTasks.includes(missionId)) {
    showError('Info', 'Cette t√¢che est d√©j√† compl√©t√©e !');
    return;
  }
  
  const mission = missions.find(m => m.id === missionId);
  if (!mission) return;
  
  if (mission.verify()) {
    progressionState.completedTasks.push(missionId);
    saveProgression();
    checkAllTasksCompleted();
    
    showNotification({
      title: '‚úì T√¢che compl√©t√©e!',
      message: mission.title,
      type: 'success'
    });
    
    // Rafra√Æchir la fen√™tre
    setTimeout(() => {
      document.querySelectorAll('.window').forEach(w => {
        if (w.querySelector('[style*="SYST√àME DE PROGRESSION"]')) {
          w.remove();
        }
      });
      openTaskManager();
    }, 300);
  } else {
    showError('T√¢che non compl√©t√©e', `${mission.title} n'est pas encore compl√©t√©e. V√©rifie les indices et r√©essaye.`);
  }
}

// ==================== LECTEUR M√âDIA ====================
function openMediaPlayer() {
  const content = `
    <div class="media-player">
      <div class="media-screen" id="mediaScreen">üîä</div>
      <div class="media-buttons">
        <button class="media-btn" onclick="playWeirdSound()">‚ñ∂ Play</button>
        <button class="media-btn" onclick="stopWeirdSound()">‚èπ Stop</button>
      </div>
    </div>
  `;
  createWindow('Lecteur m√©dia', 'üéµ', content, 400, 300);
  document.getElementById('startMenu').classList.remove('show');

  window.mediaAudio = null;
}

function playWeirdSound() {
  const screen = document.getElementById('mediaScreen');
  if (!screen) return;

  screen.textContent = '‚ñ∂ Lecture...';
  screen.style.animation = 'mediaGlitch 0.2s infinite';

  // Sons √©tranges synth√©tis√©s
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);

  const freq = [100, 200, 50, 300, 150][Math.floor(Math.random() * 5)];
  osc.frequency.value = freq;
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 2);
  
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 2);

  setTimeout(() => {
    screen.textContent = 'üîä';
    screen.style.animation = 'mediaGlitch 3s infinite';
  }, 2000);
}

function stopWeirdSound() {
  const screen = document.getElementById('mediaScreen');
  if (screen) screen.textContent = '‚èπ Arr√™t√©';
}

// ==================== JOURNAL ====================
function openJournal() {
  const today = new Date();
  const dateStr = today.toLocaleDateString('fr-FR');
  
  const content = `
    <div class="journal-container">
      <div class="journal-entries" id="journalEntries">
        <!-- Entr√©es g√©n√©r√©es dynamiquement -->
      </div>
    </div>
  `;
  createWindow('Mon journal', 'üìì', content, 500, 350);
  document.getElementById('startMenu').classList.remove('show');

  // Entr√©es corrompues et √©tranges
  const entries = [
    { date: '2024-12-01', text: 'Tout va bien. J\'ai l\'impression d\'√™tre observ√©.', corrupted: false },
    { date: '2024-12-02', text: 'Pourquoi les ombres bougent quand je ne regarde pas?', corrupted: false },
    { date: '2024-12-03', text: 'Les bruits la nuit... ce n\'est probablement rien.', corrupted: false },
    { date: '2024-12-04', text: 'J\'ai trouv√© des fichiers que je ne me souviens pas avoir cr√©√©s.', corrupted: false },
    { date: '2024-12-05', text: '‚ñà‚ñà‚ñà‚ñà‚ñà ne devrait pas √™tre ici ‚ñà‚ñà‚ñà‚ñà‚ñà', corrupted: true },
    { date: '2024-12-06', text: 'Je pense que quelqu\'un me regarde √† travers l\'√©cran...', corrupted: false },
  ];

  const entriesEl = document.getElementById('journalEntries');
  entries.forEach(entry => {
    const entryEl = document.createElement('div');
    entryEl.className = 'journal-entry';
    entryEl.innerHTML = `
      <div class="journal-date">${entry.date}</div>
      <div class="journal-text ${entry.corrupted ? 'corrupted' : ''}">${entry.text}</div>
    `;
    entriesEl.appendChild(entryEl);
  });

  // Nouvelle entr√©e toutes les 30s (limit√© √† 8 entr√©es max)
  let entryInterval = setInterval(() => {
    if (!document.getElementById('journalEntries')) {
      clearInterval(entryInterval);
      return;
    }
    
    const entriesContainer = document.getElementById('journalEntries');
    const currentCount = entriesContainer.children.length;
    
    if (currentCount < 8) {
      const randomEvents = [
        'Les fichiers changent de place...',
        'Qui regarde ma webcam?',
        'Je sens comme une pr√©sence...',
        'Le son du disque dur... √† 3h du matin.',
        '‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà'
      ];
      const newEntry = document.createElement('div');
      newEntry.className = 'journal-entry';
      const corrupted = Math.random() > 0.7;
      newEntry.innerHTML = `
        <div class="journal-date">${new Date().toLocaleTimeString('fr-FR')}</div>
        <div class="journal-text ${corrupted ? 'corrupted' : ''}">${randomEvents[Math.floor(Math.random() * randomEvents.length)]}</div>
      `;
      entriesContainer.appendChild(newEntry);
    } else if (currentCount > 8) {
      // Supprimer la premi√®re entr√©e si on d√©passe le limit
      entriesContainer.removeChild(entriesContainer.firstChild);
    }
  }, 15000);
}

// ==================== JEUX ====================

function openPong() {
  const content = `
    <div class="pong-container">
      <div class="pong-score" id="pongScore">Score: 0 - 0</div>
      <canvas class="pong-canvas" id="pongCanvas" width="600" height="400"></canvas>
      <div class="pong-hint">Utilisez les fl√®ches ‚Üë ‚Üì pour jouer</div>
    </div>
  `;
  createWindow('pong.exe', 'üéÆ', content, 650, 550);
  document.getElementById('startMenu').classList.remove('show');
  
  setTimeout(() => {
    initPong();
  }, 100);
}

function initPong() {
  const canvas = document.getElementById('pongCanvas');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;

  // --- Config globale ---
  const PADDLE_WIDTH = 12;
  const PADDLE_HEIGHT = 90;
  const BALL_SIZE = 12;

  const PLAYER_SPEED = 4;
  const AI_BASE_SPEED = 3;

  const INITIAL_BALL_SPEED = 3;
  const SPEED_INCREMENT_FACTOR = 1.02; 
  const MAX_BALL_SPEED = 10.5;

  const RALLY_EASY = 10;  // avant IA perf
  const RALLY_HARD = 22;  // IA gal√®re √† partir de ce point

  // --- √âtat du jeu ---
  let playerY = height / 2 - PADDLE_HEIGHT / 2;
  let aiY = height / 2 - PADDLE_HEIGHT / 2;

  let ballX = width / 2;
  let ballY = height / 2;
  let ballSpeedX = INITIAL_BALL_SPEED * (Math.random() > 0.5 ? 1 : -1);
  let ballSpeedY = (Math.random() - 0.5) * INITIAL_BALL_SPEED;

  let playerScore = 0;
  let aiScore = 0;
  let rallyCount = 0; // nombre de coups dans l‚Äô√©change courant

  const keys = {};

  // --- Inputs ---
  document.addEventListener('keydown', (e) => {
    keys[e.key] = true;
  });

  document.addEventListener('keyup', (e) => {
    keys[e.key] = false;
  });

  // --- Utilitaires ---
  function clampBallSpeed() {
    const speed = Math.hypot(ballSpeedX, ballSpeedY);
    if (speed > MAX_BALL_SPEED) {
      const ratio = MAX_BALL_SPEED / speed;
      ballSpeedX *= ratio;
      ballSpeedY *= ratio;
    }
  }

  function accelerateBall() {
    ballSpeedX *= SPEED_INCREMENT_FACTOR;
    ballSpeedY *= SPEED_INCREMENT_FACTOR;
    clampBallSpeed();
  }

  function resetBall(scoredByPlayer) {
    ballX = width / 2;
    ballY = height / 2;
    const direction = scoredByPlayer === 'player' ? -1 : 1;
    ballSpeedX = direction * INITIAL_BALL_SPEED;
    ballSpeedY = (Math.random() - 0.5) * INITIAL_BALL_SPEED;
    rallyCount = 0; // nouvel √©change
  }

  // Pr√©diction de la trajectoire pour l'IA
  function predictBall() {
    if (ballSpeedX <= 0) {
      return { y: height / 2, bounces: 0 };
    }

    let simX = ballX;
    let simY = ballY;
    let simVx = ballSpeedX;
    let simVy = ballSpeedY;
    const targetX = width - PADDLE_WIDTH - BALL_SIZE;

    let safety = 0;
    let bounces = 0;

    while (simX < targetX && safety < 1000) {
      simX += simVx;
      simY += simVy;

      if (simY <= 0) {
        simY = -simY;
        simVy = -simVy;
        bounces++;
      } else if (simY >= height - BALL_SIZE) {
        simY = 2 * (height - BALL_SIZE) - simY;
        simVy = -simVy;
        bounces++;
      }

      safety++;
    }

    return { y: simY + BALL_SIZE / 2, bounces };
  }

  // 0 = IA forte / concentr√©e ; >1 = IA qui commence √† se d√©grader
  function getDifficultyFactor() {
    if (rallyCount <= RALLY_EASY) return 0;
    if (rallyCount >= RALLY_HARD) {
      const extra = Math.min(1, (rallyCount - RALLY_HARD) / 10); 
      return 1 + extra * 0.7; // max ~1.7
    }
    return (rallyCount - RALLY_EASY) / (RALLY_HARD - RALLY_EASY); // 0‚Üí1
  }

  // --- Update ---
  function update() {
    const prevPlayerY = playerY;

    // Joueur
    if ((keys['ArrowUp'] || keys['z'] || keys['Z']) && playerY > 0) {
      playerY -= PLAYER_SPEED;
    }
    if ((keys['ArrowDown'] || keys['s'] || keys['S']) && playerY < height - PADDLE_HEIGHT) {
      playerY += PLAYER_SPEED;
    }

    const playerVelY = playerY - prevPlayerY;

    // IA
    const aiCenter = aiY + PADDLE_HEIGHT / 2;
    const ballSpeed = Math.hypot(ballSpeedX, ballSpeedY);
    const difficultyFactor = getDifficultyFactor();

    if (ballSpeedX > 0 && ballX > width * 0.4) {
      const prediction = predictBall();
      const predictedY = prediction.y;
      const bounceCount = prediction.bounces;

      const verticalDist = Math.abs(aiCenter - predictedY);
      const distFactor = Math.min(1, verticalDist / (height / 2));
      const normSpeed = Math.min(1, ballSpeed / MAX_BALL_SPEED);

      let errorRange = 2; // petit tremblement permanent
      let missChance = 0;
      let currentAISpeed = AI_BASE_SPEED;

      // Balle simple, si align√© sur l'IA elle l'a rate quasi jamais
      const isEasyStraight = verticalDist < height * 0.15 && bounceCount <= 1;

      if (difficultyFactor > 0) {
        const complexityFactor = 1 + Math.min(3, bounceCount) * 0.5; // + rebonds = +complexe pour l'IA

        // Erreur de vis√©e raisonnable qui augmente avec la speed de la balle
        errorRange +=
          (4 + 10 * difficultyFactor) * distFactor * complexityFactor +
          3 * normSpeed * difficultyFactor;

        // Augmentation de difficult√© si balle diff√©rente de straight pour l'IA
        if (!isEasyStraight) {
          missChance =
            0.05 * difficultyFactor +
            0.25 * difficultyFactor * distFactor +
            0.1 * normSpeed * complexityFactor;

          if (rallyCount > RALLY_HARD) {
            const extra = Math.min(1, (rallyCount - RALLY_HARD) / 10);
            missChance += 0.15 * extra * complexityFactor;
          }

          if (missChance > 0.7) missChance = 0.7;
        }

        // L‚ÄôIA garde quand m√™me du r√©pondant 
        currentAISpeed = AI_BASE_SPEED * (1 - 0.25 * Math.min(difficultyFactor, 1.5));
        if (currentAISpeed < 1.5) currentAISpeed = 1.5;
      }

      let targetY = predictedY;

      if (missChance > 0 && Math.random() < missChance && !isEasyStraight) {
        const missDir = aiCenter < predictedY ? 1 : -1;
        const missAmount = PADDLE_HEIGHT * (0.6 + Math.random() * 0.4); // entre ~0.6 et 1.0 hauteur
        targetY = predictedY + missDir * missAmount;
      }

      targetY += (Math.random() - 0.5) * errorRange;

      if (aiCenter < targetY - 10) {
        aiY += currentAISpeed;
      } else if (aiCenter > targetY + 10) {
        aiY -= currentAISpeed;
      }
    }

    aiY = Math.max(0, Math.min(height - PADDLE_HEIGHT, aiY));

    // Balle
    ballX += ballSpeedX;
    ballY += ballSpeedY;

    if (ballY <= 0) {
      ballY = 0;
      ballSpeedY = -ballSpeedY;
    } else if (ballY >= height - BALL_SIZE) {
      ballY = height - BALL_SIZE;
      ballSpeedY = -ballSpeedY;
    }

    // --- Collisions raquettes ---

    // Joueur
    if (
      ballX <= PADDLE_WIDTH &&
      ballY + BALL_SIZE >= playerY &&
      ballY <= playerY + PADDLE_HEIGHT
    ) {
      ballX = PADDLE_WIDTH;
      rallyCount++;

      const speedBefore = Math.hypot(ballSpeedX, ballSpeedY);

      let newVx = Math.abs(ballSpeedX);

      const paddleCenter = playerY + PADDLE_HEIGHT / 2;
      const ballCenterY = ballY + BALL_SIZE / 2;
      const impact = (ballCenterY - paddleCenter) / (PADDLE_HEIGHT / 2);

      const impactInfluence = 0.6;
      const inertiaInfluence = 0.4;

      let newVy =
        impact * impactInfluence * speedBefore +
        (playerVelY / PLAYER_SPEED) * inertiaInfluence * speedBefore;

      const maxVy = speedBefore * 0.9;
      if (newVy > maxVy) newVy = maxVy;
      if (newVy < -maxVy) newVy = -maxVy;

      const vxSquared = Math.max(
        speedBefore * speedBefore - newVy * newVy,
        (speedBefore * 0.4) ** 2
      );
      newVx = Math.sqrt(vxSquared);

      ballSpeedX = newVx;
      ballSpeedY = newVy;

      accelerateBall();
    }

    // IA
    if (
      ballX + BALL_SIZE >= width - PADDLE_WIDTH &&
      ballY + BALL_SIZE >= aiY &&
      ballY <= aiY + PADDLE_HEIGHT
    ) {
      ballX = width - PADDLE_WIDTH - BALL_SIZE;
      rallyCount++;

      const speedBefore = Math.hypot(ballSpeedX, ballSpeedY);

      let newVx = -Math.abs(ballSpeedX);

      const paddleCenter = aiY + PADDLE_HEIGHT / 2;
      const ballCenterY = ballY + BALL_SIZE / 2;
      const impact = (ballCenterY - paddleCenter) / (PADDLE_HEIGHT / 2);

      let newVy = impact * 0.5 * speedBefore;

      const maxVy = speedBefore * 0.9;
      if (newVy > maxVy) newVy = maxVy;
      if (newVy < -maxVy) newVy = -maxVy;

      const vxSquared = Math.max(
        speedBefore * speedBefore - newVy * newVy,
        (speedBefore * 0.4) ** 2
      );
      newVx = -Math.sqrt(vxSquared);

      ballSpeedX = newVx;
      ballSpeedY = newVy;

      accelerateBall();
    }

    // Score
    if (ballX < -BALL_SIZE) {
      aiScore++;
      resetBall('ai');
    } else if (ballX > width + BALL_SIZE) {
      playerScore++;
      resetBall('player');

      if (playerScore >= 5) {
        // Track win
        if (!window.pongPlayerWins) window.pongPlayerWins = 0;
        window.pongPlayerWins++;
        
        if (typeof triggerScreamer === 'function') triggerScreamer();
        const activeWin = document.querySelector('.window.active');
        if (activeWin && typeof closeWindow === 'function') {
          closeWindow(activeWin.id);
        }
      }
    }

    const scoreEl = document.getElementById('pongScore');
    if (scoreEl) {
      scoreEl.textContent = `Score: ${playerScore} - ${aiScore}`;
    }
  }

  // --- Dessin ---
  function draw() {
    const gradient = ctx.createLinearGradient(0, 0, width, height);
    gradient.addColorStop(0, '#050510');
    gradient.addColorStop(1, '#131336');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);

    ctx.save();
    ctx.setLineDash([10, 10]);
    ctx.strokeStyle = '#3a3a5a';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(width / 2, 0);
    ctx.lineTo(width / 2, height);
    ctx.stroke();
    ctx.restore();

    ctx.save();
    ctx.shadowBlur = 18;
    ctx.shadowColor = '#40e0ff';

    ctx.fillStyle = '#e8f9ff';
    ctx.fillRect(0, playerY, PADDLE_WIDTH, PADDLE_HEIGHT);
    ctx.fillRect(width - PADDLE_WIDTH, aiY, PADDLE_WIDTH, PADDLE_HEIGHT);

    ctx.beginPath();
    ctx.arc(
      ballX + BALL_SIZE / 2,
      ballY + BALL_SIZE / 2,
      BALL_SIZE / 2,
      0,
      Math.PI * 2
    );
    ctx.fillStyle = '#ffffff';
    ctx.fill();
    ctx.restore();
  }

  // --- Boucle de jeu ---
  function gameLoop() {
    if (!document.getElementById('pongCanvas')) return;
    update();
    draw();
    requestAnimationFrame(gameLoop);
  }

  gameLoop();
}
function triggerBSOD() {
  const bsod = document.getElementById('bsod');
  bsod.classList.add('active');
  
  // Jouer un son d'erreur
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.type = 'sine';
  osc.frequency.value = 200;
  gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.8);
  
  // Fermer toutes les fen√™tres
  setTimeout(() => {
    document.querySelectorAll('.window').forEach(w => w.remove());
    openWindows = [];
    activeWindow = null;
    updateTaskbar();
  }, 500);
}

function triggerScreamer() {
  const screamer = document.getElementById('screamer');
  screamer.style.display = 'flex';
  playScreamerSound();
  
  setTimeout(() => {
    screamer.style.display = 'none';
  }, 300);
}

// ==================== WEBCAM FAKE ====================
function openWebcam() {
  const content = `
    <div class="webcam-container">
      <div class="webcam-status">
        <span class="webcam-indicator"></span>
        ENREGISTREMENT EN COURS
      </div>
      <div style="color: #666; font-size: 48px;">üìπ</div>
      <div style="color: #666; margin-top: 20px;">Aucun p√©riph√©rique d√©tect√©</div>
      <div style="color: #999; font-size: 11px; margin-top: 10px;">Mais je te vois quand m√™me.</div>
    </div>
  `;
  createWindow('Webcam', 'üìπ', content, 500, 400);
  document.getElementById('startMenu').classList.remove('show');
}

// ==================== MESSAGES D'ERREUR ====================
function showError(title, message) {
  document.getElementById('errorTitle').textContent = title;
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('errorDialog').classList.add('show');
  playErrorSound();
}

function closeError() {
  document.getElementById('errorDialog').classList.remove('show');
}

// ==================== CREEPY SOUND ====================

let creepyAudioCtx = null;

function playCreepyAudio(durationMs = 3300) {
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  if (!AudioCtx) return;

  if (!creepyAudioCtx) creepyAudioCtx = new AudioCtx();
  const ctx = creepyAudioCtx;

  // Certains navigateurs n√©cessitent un "resume" apr√®s interaction utilisateur
  if (ctx.state === "suspended") ctx.resume();

  const now = ctx.currentTime;
  const dur = durationMs / 1000;

  // Master gain (volume global) ‚Äî reste raisonnable
  const master = ctx.createGain();
  master.gain.setValueAtTime(0.0001, now);
  master.gain.exponentialRampToValueAtTime(0.12, now + 0.06); // mont√©e douce
  master.gain.setValueAtTime(0.10, now + dur - 0.12);
  master.gain.exponentialRampToValueAtTime(0.0001, now + dur);

  // Filtre pour ‚Äúanalog dread‚Äù
  const filter = ctx.createBiquadFilter();
  filter.type = "lowpass";
  filter.frequency.setValueAtTime(900, now);
  filter.frequency.linearRampToValueAtTime(650, now + dur * 0.6);
  filter.frequency.linearRampToValueAtTime(800, now + dur);
  filter.Q.setValueAtTime(0.9, now);

  // Tremolo (amplitude modulation) pour l‚Äôinstabilit√©
  const tremoloGain = ctx.createGain();
  tremoloGain.gain.setValueAtTime(1.0, now);

  const tremoloOsc = ctx.createOscillator();
  tremoloOsc.type = "sine";
  tremoloOsc.frequency.setValueAtTime(6.5, now);

  const tremoloDepth = ctx.createGain();
  tremoloDepth.gain.setValueAtTime(0.35, now); // profondeur

  tremoloOsc.connect(tremoloDepth);
  tremoloDepth.connect(tremoloGain.gain);

  // Drone (2 oscillateurs l√©g√®rement detun√©s)
  const o1 = ctx.createOscillator();
  o1.type = "sawtooth";
  o1.frequency.setValueAtTime(58, now); // base
  o1.detune.setValueAtTime(-9, now);

  const o2 = ctx.createOscillator();
  o2.type = "triangle";
  o2.frequency.setValueAtTime(58.7, now);
  o2.detune.setValueAtTime(11, now);

  const droneGain = ctx.createGain();
  droneGain.gain.setValueAtTime(0.55, now);

  // Bruit (white noise) filtr√© pour ‚Äúgrain / static‚Äù
  const noiseBuf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * dur), ctx.sampleRate);
  const data = noiseBuf.getChannelData(0);
  for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * 0.18;

  const noise = ctx.createBufferSource();
  noise.buffer = noiseBuf;

  const noiseFilter = ctx.createBiquadFilter();
  noiseFilter.type = "bandpass";
  noiseFilter.frequency.setValueAtTime(1200, now);
  noiseFilter.Q.setValueAtTime(0.7, now);

  const noiseGain = ctx.createGain();
  noiseGain.gain.setValueAtTime(0.0, now);
  noiseGain.gain.linearRampToValueAtTime(0.30, now + 0.08);
  noiseGain.gain.setValueAtTime(0.22, now + dur - 0.18);
  noiseGain.gain.linearRampToValueAtTime(0.0, now + dur);

  // ‚ÄúPops‚Äù rares (petits clicks) pour glitch
  const popGain = ctx.createGain();
  popGain.gain.setValueAtTime(0.0, now);

  function schedulePop(t) {
    const osc = ctx.createOscillator();
    osc.type = "square";
    osc.frequency.setValueAtTime(220 + Math.random() * 160, t);

    const g = ctx.createGain();
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.08, t + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.03);

    osc.connect(g);
    g.connect(popGain);

    osc.start(t);
    osc.stop(t + 0.04);
  }

  // 6‚Äì10 pops r√©partis
  const pops = 6 + Math.floor(Math.random() * 5);
  for (let i = 0; i < pops; i++) {
    const t = now + 0.15 + Math.random() * (dur - 0.35);
    schedulePop(t);
  }

  // Routing
  o1.connect(droneGain);
  o2.connect(droneGain);
  droneGain.connect(tremoloGain);
  tremoloGain.connect(filter);

  noise.connect(noiseFilter);
  noiseFilter.connect(noiseGain);
  noiseGain.connect(filter);

  popGain.connect(filter);

  filter.connect(master);
  master.connect(ctx.destination);

  // Start/Stop
  tremoloOsc.start(now);
  o1.start(now);
  o2.start(now);
  noise.start(now);

  const stopAt = now + dur;
  tremoloOsc.stop(stopAt);
  o1.stop(stopAt);
  o2.stop(stopAt);
  noise.stop(stopAt);

  // nettoyage (optionnel)
  setTimeout(() => {
    try { master.disconnect(); } catch {}
  }, durationMs + 250);
}



// ==================== SPRITE ANIMATION ====================

// ===== CONFIG =====
const FRAME_DIR = "images/creepysprite/";      // ‚úÖ NOUVEAU: dossier des images
const FRAME_PREFIX = "creepy";    // creepy1.png, creepy2.png, ...
const MAX_FRAME = 11;             // creepy1..creepy11
const EXT = ".png";

// Cadre d‚Äôaffichage (doit matcher le CSS)
const BOX_W = 256;
const BOX_H = 384;

// ‚úÖ 11 timings (ms) pour 11 frames
// (progressif: lent -> plus rapide -> lent)
const FRAME_DELAYS = [
  260, 240, 220, 200, 190, 180, 180, 200, 220, 250, 300
];

const HOLD_LAST_MS = 350;  // pause sur la derni√®re frame
const FADE_OUT_MS = 180;

function buildFrameList() {
  const frames = [];
  for (let i = 1; i <= MAX_FRAME; i++) {
    // ‚úÖ CHANGEMENT: pr√©fixe images/
    frames.push(`${FRAME_DIR}${FRAME_PREFIX}${i}${EXT}`);
  }
  return frames;
}

function randomPos() {
  const maxX = Math.max(0, window.innerWidth - BOX_W);
  const maxY = Math.max(0, window.innerHeight - BOX_H - 40);
  return {
    x: Math.floor(Math.random() * (maxX + 1)),
    y: Math.floor(Math.random() * (maxY + 1)),
  };
}

// Pr√©charge pour √©viter clignotements (optionnel mais conseill√©)
function preloadFrames(urls) {
  return Promise.all(
    urls.map(
      (url) =>
        new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve({ url, ok: true });
          img.onerror = () => resolve({ url, ok: false });
          img.src = url;
        })
    )
  );
}

async function spawnCreepy() {
  const frames = buildFrameList();

  // Pr√©charge (et ignore celles manquantes)
  const results = await preloadFrames(frames);
  const available = results.filter((r) => r.ok).map((r) => r.url);

  if (available.length === 0) {
    alert("Aucune frame trouv√©e (ex: images/creepy1.png). V√©rifie le dossier images/.");
    return;
  }

  // ‚úÖ Dur√©e audio: somme des delays r√©ellement jou√©s + hold + fade (approx)
  // Tu peux aussi mettre une valeur fixe (ex: 4200).
  const audioMs =
    FRAME_DELAYS.slice(0, Math.min(available.length, FRAME_DELAYS.length)).reduce((a, b) => a + b, 0) +
    HOLD_LAST_MS +
    FADE_OUT_MS;

  playCreepyAudio(audioMs);

  // Cadre
  const wrap = document.createElement("div");
  wrap.className = "creepy-frame";

  const pos = randomPos();
  wrap.style.left = pos.x + "px";
  wrap.style.top = pos.y + "px";

  const img = document.createElement("img");
  wrap.appendChild(img);
  document.body.appendChild(wrap);

  let i = 0;
  img.src = available[i];

  // Lecture avec d√©lais variables
  const step = () => {
    i++;

    if (i >= available.length) {
      // pause derni√®re frame, puis fade out
      setTimeout(() => {
        wrap.style.transition = `opacity ${FADE_OUT_MS}ms linear`;
        wrap.style.opacity = "0";
        setTimeout(() => wrap.remove(), FADE_OUT_MS);
      }, HOLD_LAST_MS);
      return;
    }

    img.src = available[i];

    const delay =
      FRAME_DELAYS[i] ??
      FRAME_DELAYS[FRAME_DELAYS.length - 1] ??
      220;

    setTimeout(step, delay);
  };

  // premier d√©lai
  const firstDelay = FRAME_DELAYS[0] ?? 260;
  setTimeout(step, firstDelay);
}

// expose la fonction pour onclick
window.spawnCreepy = spawnCreepy;

// ==================== ARR√äT DU SYST√àME ====================
function shutdown() {
  document.body.style.transition = 'opacity 2s';
  document.body.style.opacity = '0';
  setTimeout(() => {
    document.body.innerHTML = '<div style="width:100vw;height:100vh;background:#000;display:flex;align-items:center;justify-content:center;color:#fff;font-family:Tahoma;font-size:20px;flex-direction:column;gap:20px;"><div>Il est maintenant possible d\'√©teindre votre ordinateur en toute s√©curit√©.</div><div style="font-size:14px;color:#666;">Tu reviendras. Ils reviennent toujours.</div></div>';
    document.body.style.opacity = '1';
  }, 2000);
}

// ==================== D√âMARRAGE ====================
window.onload = init;
</script>

</body>
</html>


